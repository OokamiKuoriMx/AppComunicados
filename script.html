<script>

    // =========================================================================
    // √ÅREA DE UTILIDADES Y CONFIGURACI√ìN
    // =========================================================================

    // --- 1.1: Declaraciones de Estado Global ---
    let appRoot;
    let appLoader;
    let componentScriptAnchor;

    // ============================================================
    // üîß MODO DESARROLLO
    // ============================================================
    const DEV_MODE = true;
    // ============================================================

    // Control de logging basado en DOMContentLoaded
    let isDOMReady = false;
    let logQueue = [];

    /**
     * Wrapper para console.log que solo imprime si DEV_MODE est√° activo
     */
    function devLog(...args) {
        if (!DEV_MODE) return;
        if (isDOMReady) {
            console.log(...args);
        }
    }

    // Activar logging cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
        isDOMReady = true;
        logQueue.forEach(args => console.log(...args));
        logQueue = [];
    }, { once: true });

    // --- 1.2: Caches Globales ---
    const TEMPLATES = Object.create(null);
    globalThis.TEMPLATES = TEMPLATES; // Exponer globalmente para componentes
    const loadedScripts = new Set();

    // --- 1.3: Utilidad de Saneamiento ---
    function escapeHtml(s) {
        if (!s) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // --- 1.4: Utilidades DOM ---
    function removeById(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function removeComponentScript() {
        removeById('componentScript');
    }

    function extractScriptContent(html) {
        const div = document.createElement('div');
        div.innerHTML = html;
        const script = div.querySelector('script');

        // DEBUG EXTRACCION
        if (!script) {
            console.error('‚ùå extractScriptContent: No se encontr√≥ etiqueta <script> en el fragmento HTML.');
            devLog('Fragmento recibido (primeros 100 caracteres):', html.substring(0, 100));
            return '';
        }
        const content = script.textContent;
        devLog(`‚úÖ Contenido extra√≠do de <script>. Longitud: ${content.length}`);
        return content;
    }

    function setAppLoading(isLoading) {
        console.log(`üü° setAppLoading llamado con isLoading=${isLoading}`);
        if (appLoader) {
            console.log('üü° appLoader encontrado, aplicando cambios...');
            if (isLoading) {
                // Resetear mensaje a gen√©rico antes de mostrar
                const loaderTitle = document.getElementById('app-loader-title');
                const loaderMessage = document.getElementById('app-loader-message');
                if (loaderTitle) loaderTitle.textContent = 'Cargando...';
                if (loaderMessage) loaderMessage.textContent = 'Por favor espera un momento.';

                // Mostrar loader
                appLoader.classList.remove('d-none');
                appLoader.style.opacity = '1';
                appLoader.style.visibility = 'visible';
            } else {
                // Ocultar loader con fade suave
                appLoader.style.opacity = '0';
                // Esperar a que complete la transici√≥n antes de ocultar completamente
                setTimeout(() => {
                    appLoader.classList.add('d-none');
                    appLoader.style.visibility = 'hidden';
                }, 250); // Mismo timing que --transition-base
                console.log('‚úÖ Loader ocultado correctamente');
            }
        } else {
            console.error('‚ùå appLoader NO encontrado en setAppLoading');
        }
    }

    function injectComponentScript(code) {
        if (!code) {
            console.error('‚ùå injectComponentScript: code es null/vac√≠o');
            return;
        }
        removeComponentScript();
        const scriptEl = document.createElement('script');
        scriptEl.id = 'componentScript';

        const extracted = extractScriptContent(code);
        if (!extracted) {
            console.error('‚ùå injectComponentScript: El contenido extra√≠do est√° vac√≠o.');
            return;
        }

        devLog(`Inyectando script de componente (Longitud final: ${extracted.length})`);
        scriptEl.textContent = extracted;
        (componentScriptAnchor?.parentNode || document.body || document.documentElement).appendChild(scriptEl);
    }

    function loadServerFragment(name) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(result => {
                    if (result && result[name]) {
                        resolve(result[name]);
                    } else {
                        resolve('');
                    }
                })
                .withFailureHandler(reject)
                .getTemplates([name]);
        });
    }

    // --- 1.5: Componentes Est√°ticos ---
    const Home = {
        render: () => `
            <div class="jumbotron mt-4">
                <h1 class="display-4">Bienvenido al Gestor de Comunicados</h1>
                <p class="lead">Seleccione una opci√≥n del men√∫ para comenzar.</p>
                <hr class="my-4">
                <p>Utilice la barra lateral para navegar entre los m√≥dulos.</p>
            </div>
        `
    };

    const About = {
        render: () => `
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Acerca de</h5>
                    <p class="card-text">Versi√≥n 1.0.0</p>
                    <p class="card-text">Desarrollado para gesti√≥n eficiente de comunicados.</p>
                </div>
            </div>
        `
    };

    const NotFound = {
        render: () => `
            <div class="alert alert-warning mt-4">
                <h4 class="alert-heading">404 - P√°gina no encontrada</h4>
                <p>La ruta solicitada no existe.</p>
                <hr>
                <p class="mb-0"><a href="#/">Volver al inicio</a></p>
            </div>
        `
    };

    // --- 1.6: Configuraci√≥n de Rutas ---
    const staticRoutes = {
        '#/': Home,
        '#/about': About
    };

    const lazyRouteConfigs = {
        '#/cuentas': {
            script: 'cuentas.js',
            template: 'cuentas',
            global: 'Cuentas'
        },
        '#/comunicados': {
            script: 'comunicados.js',
            template: 'comunicados',
            global: 'Comunicados'
        },
        '#/comunicado-detalle': {
            script: 'comunicado_detalle.js',
            template: 'comunicado_detalle',
            global: 'ComunicadoDetalle'
        },
        '#/catalogos': {
            script: 'catalogos.js',
            template: 'catalogos',
            global: 'Catalogos'
        },
        '#/importaciones': {
            script: 'importaciones.js',
            template: 'importaciones',
            global: 'Importaciones'
        }

    };

    // --- 1.7: Utiler√≠as de Comunicaci√≥n (Google) ---
    if (!globalThis.fetchTemplates) {
        globalThis.fetchTemplates = function fetchTemplates(name) {
            if (!name) return Promise.resolve(null);
            if (TEMPLATES[name]) return Promise.resolve(TEMPLATES[name]);
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(result => {
                        const template = result && result[name] ? result[name] : null;
                        if (template) {
                            TEMPLATES[name] = template;
                        }
                        resolve(template);
                    })
                    .withFailureHandler(reject)
                    .getTemplates([name]);
            });
        };
    }

    if (!globalThis.runServer) {
        globalThis.runServer = function runServer(functionName, ...args) {
            return new Promise((resolve, reject) => {
                const runner = google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject);
                if (typeof runner[functionName] === 'function') {
                    runner[functionName](...args);
                } else {
                    reject(new Error(`Funci√≥n de servidor "${functionName}" no encontrada.`));
                }
            });
        };
    }

    if (!globalThis.serverCall) {
        globalThis.serverCall = function serverCall(funcName, ...args) {
            devLog(`Invocando serverCall a ${funcName} con argumentos: `, args);
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => {
                        devLog(`serverCall ${funcName}: respuesta recibida`, response);
                        if (response && response.success) {
                            resolve(response.data);
                            return;
                        }
                        const isNullish = response === null || response === undefined;
                        if (isNullish) {
                            console.error(`serverCall ${funcName}: la funci√≥n devolvi√≥ una respuesta vac√≠a.`);
                            reject(new Error(`La funci√≥n ${funcName} devolvi√≥ una respuesta vac√≠a.`));
                            return;
                        }
                        let message = '';
                        if (response && typeof response === 'object') {
                            message = response.message || response.error || '';
                            if (!message) {
                                try {
                                    message = `Respuesta inesperada: ${JSON.stringify(response)} `;
                                } catch (jsonError) {
                                    message = 'Respuesta inesperada sin contenido legible.';
                                }
                            }
                        }
                        const finalMessage = message ? `Error en ${funcName}: ${message} ` : `Error en la operaci√≥n: ${funcName}.`;
                        reject(new Error(finalMessage));
                    })
                    .withFailureHandler(error => {
                        console.error(`serverCall ${funcName}: fallo en la invocaci√≥n`, error);
                        const message = error?.message ? `${error.message} (funci√≥n ${funcName})` : `Error inesperado al invocar ${funcName} `;
                        reject(new Error(message));
                    })
                [funcName](...args);
            });
        };
    }

    if (!globalThis.serverApi) {
        globalThis.serverApi = {
            readCuentas() {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .readCuentas();
                });
            },
            readAllComunicados() {
                return globalThis.serverCall('readAllComunicados');
            }
        };
    }

    // =========================================================================
    // L√ìGICA PRINCIPAL (7 PASOS)
    // =========================================================================

    function app_Init() {
        devLog('--- PASO 1: Inicio de la Aplicaci√≥n ---');
        appRoot = document.getElementById('app');
        appLoader = document.getElementById('app-loader');
        componentScriptAnchor = document.getElementById('componentScript');

        console.log('üîç Verificando elementos:');
        console.log('  - appRoot:', appRoot ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        console.log('  - appLoader:', appLoader ? '‚úÖ Encontrado' : '‚ùå NO encontrado');
        console.log('  - componentScriptAnchor:', componentScriptAnchor ? '‚úÖ Encontrado' : '‚ùå NO encontrado');

        devLog('‚úÖ PASO 1 completado');
    }



    /**
     * Carga un script JS din√°micamente si no est√° cargado a√∫n.
     * @param {string} scriptName Nombre del archivo script (ej: 'comunicados.js')
     */
    async function loadDynamicScript(scriptName) {
        if (loadedScripts.has(scriptName)) {
            devLog(`Script ${scriptName} ya estaba cargado.`);
            return true;
        }

        devLog(`Cargando script din√°mico: ${scriptName}`);
        try {
            const code = await loadServerFragment(scriptName);
            if (!code || code.length < 10) {
                console.error(`‚ö†Ô∏è Script din√°mico ${scriptName} parece vac√≠o o muy corto.`);
                return false;
            }
            injectComponentScript(code);
            loadedScripts.add(scriptName);
            // Dar tiempo al navegador para parsear y ejecutar
            await new Promise(r => setTimeout(r, 100));
            devLog(`‚úÖ Script din√°mico ${scriptName} cargado correctamente.`);
            return true;
        } catch (err) {
            console.error(`‚ùå Fallo al cargar script din√°mico ${scriptName}`, err);
            return false;
        }
    }

    // Exponer globalmente
    globalThis.loadDynamicScript = loadDynamicScript;

    async function app_ResolveRoute(hash) {
        devLog(`--- PASO 2: Resolviendo Ruta[${hash}]--- `);
        if (staticRoutes[hash]) {
            devLog('‚úÖ PASO 2 completado (Ruta Est√°tica)');
            return staticRoutes[hash];
        }
        if (lazyRouteConfigs[hash]) {
            const config = lazyRouteConfigs[hash];
            devLog(`Ruta din√°mica detectada. Config: `, config);
            if (config.script && !loadedScripts.has(config.script)) {
                try {
                    const code = await loadServerFragment(config.script);
                    devLog(`Script cargado para ${hash}. Longitud: ${code ? code.length : 0}`);
                    if (!code || code.length < 10) {
                        console.error(`‚ö†Ô∏è Script ${config.script} parece vac√≠o o muy corto.`);
                    }
                    injectComponentScript(code);
                    loadedScripts.add(config.script);
                    // Give the browser a moment to execute the script
                    await new Promise(r => setTimeout(r, 100)); // Increased timeout

                    // DEBUG: Verificar si se defini√≥
                    if (globalThis[config.global] || window[config.global]) {
                        devLog(`‚úÖ Global ${config.global} detectado despu√©s de carga.`);
                    } else {
                        console.error(`‚ùå Global ${config.global} NO detectado despu√©s de carga y espera.`);
                        // Intento de fallback: buscar si est√° en window expl√≠citamente y asignar a globalThis
                        if (window[config.global]) globalThis[config.global] = window[config.global];
                    }

                } catch (err) {
                    console.error(`Fallo al cargar script para ${hash} `, err);
                    return NotFound;
                }
            }
            const component = globalThis[config.global];
            if (component) {
                devLog('‚úÖ PASO 2 completado (Ruta Din√°mica)');
                return component;
            } else {
                console.error(`Script ${config.script} cargado, pero global.${config.global} no se encontr√≥.`);
                return NotFound;
            }
        }
        devLog('‚úÖ PASO 2 completado (Ruta No Encontrada)');
        return NotFound;
    }

    async function app_AcquireTemplate(hash) {
        devLog(`--- PASO 3: Adquiriendo Plantilla[${hash}]--- `);
        const config = lazyRouteConfigs[hash];
        if (config && config.template && !TEMPLATES[config.template]) {
            try {
                await fetchTemplates(config.template);
                devLog('‚úÖ PASO 3 completado (Plantilla descargada)');
            } catch (err) {
                if (DEV_MODE) console.error(`‚ùå PASO 3 Fallo al cargar plantilla ${config.template} `, err);
            }
        } else {
            devLog('‚úÖ PASO 3 completado (Est√°tica o en Cach√©)');
        }
    }

    function app_RenderTemplate(component) {
        devLog('--- PASO 4: Renderizando Plantilla ---');
        if (appRoot.__mounted && typeof appRoot.__mounted.unmount === 'function') {
            try { appRoot.__mounted.unmount(appRoot); } catch (e) { console.error('unmount error', e); }
        }
        removeById('component-script');
        removeById('component-style');
        const renderFn = typeof component.renderizar === 'function' ? component.renderizar : component.render;
        if (typeof renderFn === 'function') {
            appRoot.innerHTML = renderFn.call(component);
        } else {
            appRoot.innerHTML = '<section class="card"><h1>Error: Componente sin render()</h1></section>';
        }
        appRoot.__mounted = component;
        devLog('‚úÖ PASO 4 completado');
    }

    async function app_MountComponent(component) {
        devLog('--- PASO 5: Montando Componente ---');
        if (typeof component.mount === 'function') {
            try {
                await component.mount(appRoot);
            } catch (e) {
                console.error('Error en mount():', e);
            }
        }
        devLog('‚úÖ PASO 5 completado');
    }

    function setActiveNav() {
        const hash = location.hash || '#/';
        // Buscar enlaces en el nuevo sidebar (.sidebar-link) y en el antiguo (.nav a)
        document.querySelectorAll('.sidebar-link, .nav a').forEach(a => {
            a.classList.toggle('active', a.getAttribute('href') === hash);
        });
    }

    async function app_PostMountTasks(component) {
        devLog('--- PASO 6: Tareas Post-Montaje ---');
        const afterRenderFn = typeof component.despuesDeRenderizar === 'function' ? component.despuesDeRenderizar : component.afterRender;
        if (typeof afterRenderFn === 'function') {
            try {
                const result = afterRenderFn.call(component);
                if (result && typeof result.then === 'function') {
                    await result;
                }
            } catch (e) { console.error('afterRender error', e); }
        }
        devLog('‚úÖ PASO 6 completado');
    }

    function app_AppReady() {
        devLog('--- PASO 7: Aplicaci√≥n Lista ---');
        setAppLoading(false);
        devLog('‚úÖ PASO 7 completado');
    }

    // --- Funci√≥n Orquestadora ---
    let currentNavigationId = 0; // ID para cancelar navegaciones anteriores

    async function navigate(hash) {
        // Incrementar ID para esta navegaci√≥n
        const thisNavigationId = ++currentNavigationId;

        devLog(`\n\n ==== Navegando a: ${hash} (nav-id: ${thisNavigationId}) ====`);

        // ‚úÖ MEJORADO: Activar la navegaci√≥n INMEDIATAMENTE para feedback visual instant√°neo
        setActiveNav();

        setAppLoading(true);

        try {
            // Verificar si esta navegaci√≥n sigue siendo v√°lida
            const isCancelled = () => currentNavigationId !== thisNavigationId;

            const component = await app_ResolveRoute(hash);
            if (isCancelled()) {
                devLog(`‚èπÔ∏è Navegaci√≥n ${thisNavigationId} cancelada (ResolveRoute)`);
                return;
            }

            await app_AcquireTemplate(hash);
            if (isCancelled()) {
                devLog(`‚èπÔ∏è Navegaci√≥n ${thisNavigationId} cancelada (AcquireTemplate)`);
                return;
            }

            app_RenderTemplate(component);

            await app_MountComponent(component);
            if (isCancelled()) {
                devLog(`‚èπÔ∏è Navegaci√≥n ${thisNavigationId} cancelada (MountComponent)`);
                return;
            }

            await app_PostMountTasks(component);

            if (isInitialLoad) {
                app_AppReady();
            } else {
                setAppLoading(false); // Ocultar AQU√ç, al final
                devLog('--- Navegaci√≥n completada ---');
            }
        } catch (error) {
            // Solo mostrar error si esta navegaci√≥n sigue siendo la activa
            if (currentNavigationId === thisNavigationId) {
                console.error('Error en navegaci√≥n:', error);
                setAppLoading(false);
                appRoot.innerHTML = `<div class="alert alert-danger">Error al cargar la vista: ${error.message}</div>`;
            }
        }
    }

    // Bandera para evitar doble navegaci√≥n en la carga inicial
    let isInitialLoad = true;

    // Escuchar cambios de navegaci√≥n
    window.addEventListener('hashchange', () => {
        if (isInitialLoad) {
            isInitialLoad = false;
            return;
        }
        navigate(location.hash).catch(err => console.error(err));
    });

    // Iniciar la carga de la p√°gina por primera vez
    document.addEventListener('DOMContentLoaded', () => {
        devLog('Evento: DOMContentLoaded. Iniciando carga...');
        app_Init();

        // Safety timeout: Force hide loader after 5 seconds if still loading
        setTimeout(() => {
            if (isInitialLoad) {
                console.warn('‚ö†Ô∏è Safety timeout triggered: Forcing loader hide.');
                setAppLoading(false);
                if (appRoot && appRoot.innerHTML.trim() === '') {
                    appRoot.innerHTML = '<div class="alert alert-warning">La aplicaci√≥n tard√≥ demasiado en cargar. Intente recargar la p√°gina.</div>';
                }
                isInitialLoad = false;
            }
        }, 5000);

        if (!location.hash) {
            location.hash = '#/';
        }
        navigate(location.hash)
            .then(() => {
                isInitialLoad = false;
            })
            .catch(err => {
                console.error('Error cr√≠tico en carga inicial:', err);
                setAppLoading(false);
                if (appRoot) {
                    appRoot.innerHTML = `<div class="alert alert-danger">Error cr√≠tico: ${err.message}</div>`;
                }
                isInitialLoad = false;
            });
    });
</script>