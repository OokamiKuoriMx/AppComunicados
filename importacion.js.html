<script>
    /**
     * MÓDULO IMPORTACIÓN FRONTEND
     * Maneja la carga de archivos y la comunicación con el backend.
     */
    globalThis.Importacion = (() => {
        'use strict';

        const dom = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            fileInfo: document.getElementById('file-info'),
            filenameDisplay: document.getElementById('filename-display'),
            btnAnalizar: document.getElementById('btn-analizar'),
            loader: document.getElementById('import-loader'),
            loaderMsg: document.getElementById('loader-msg'),
            previewContainer: document.getElementById('preview-container'),
            previewBody: document.getElementById('preview-body'),
            previewSummary: document.getElementById('preview-summary')
        };

        let currentFile = null;

        const init = () => {
            _addEventListeners();
        };

        const _addEventListeners = () => {
            // Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dom.dropZone.addEventListener(eventName, _preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dom.dropZone.addEventListener(eventName, () => dom.dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dom.dropZone.addEventListener(eventName, () => dom.dropZone.classList.remove('dragover'), false);
            });

            dom.dropZone.addEventListener('drop', _handleDrop, false);
            dom.fileInput.addEventListener('change', _handleFileSelect, false);
        };

        const _preventDefaults = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        const _handleDrop = (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            _handleFiles(files);
        };

        const _handleFileSelect = (e) => {
            const files = e.target.files;
            _handleFiles(files);
        };

        const _handleFiles = (files) => {
            if (files.length > 0) {
                currentFile = files[0];
                dom.filenameDisplay.textContent = currentFile.name;
                dom.fileInfo.classList.remove('d-none');
                dom.btnAnalizar.disabled = false;
            }
        };

        const reset = () => {
            currentFile = null;
            dom.fileInput.value = '';
            dom.fileInfo.classList.add('d-none');
            dom.btnAnalizar.disabled = true;
            dom.previewContainer.classList.add('d-none');
            dom.previewBody.innerHTML = '';
        };

        const analizar = () => {
            if (!currentFile) return;

            const fileName = currentFile.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

            if (isExcel) {
                _procesarExcel(currentFile);
            } else {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result;
                    await _procesarBackend(content);
                };
                reader.readAsText(currentFile);
            }
        };

        const _procesarExcel = async (file) => {
            _showLoader(true, 'Procesando archivo Excel...');

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    const result = await serverCall('convertirExcelACsv', base64Data);

                    if (result.success) {
                        await _procesarBackend(result.csvContent);
                    } else {
                        alert('Error al procesar Excel: ' + result.message);
                        _showLoader(false);
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error(error);
                alert('Error al leer el archivo Excel: ' + error.message);
                _showLoader(false);
            }
        };

        const _procesarBackend = async (csvContent) => {
            _showLoader(true, 'Analizando, Validando y Persistiendo Datos...');

            try {
                // Llamada al orquestador backend (Paso 7)
                const result = await serverCall('ejecutarImportacion', csvContent);

                _renderResultados(result);

                if (result.success) {
                    if (globalThis.Swal) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Importación Completada',
                            text: result.message + `\nTotal: ${result.resumen?.totalDocumentos} | Nuevos Siniestros: ${result.resumen?.nuevosSiniestros}`,
                            confirmButtonColor: '#0d6efd'
                        });
                    } else {
                        alert(`Importación Completada.\n${result.message}`);
                    }

                    // Recargar tabla principal si existe el módulo Comunicados
                    if (globalThis.Comunicados && typeof Comunicados.recargar === 'function') {
                        Comunicados.recargar();
                    }
                } else {
                    alert('Error en la importación: ' + result.message);
                }

            } catch (error) {
                console.error(error);
                alert('Error crítico de comunicación: ' + error.message);
            } finally {
                _showLoader(false);
            }
        };

        const _renderResultados = (result) => {
            dom.previewContainer.classList.remove('d-none');
            dom.previewBody.innerHTML = '';

            const resumen = result.resumen || {};
            dom.previewSummary.innerHTML = `
                <strong>Procesados:</strong> ${resumen.procesados || 0} <span class="mx-2">|</span>
                <strong>Omitidos:</strong> ${resumen.omitidos || 0} <span class="mx-2">|</span>
                <strong>Nuevos Siniestros:</strong> ${resumen.nuevosSiniestros || 0}
            `;

            // Manejo de Reporte de Errores
            if (resumen.omitidos > 0 && result.csvErrorContent) {
                dom.errorReportContainer.classList.remove('d-none');
                dom.errorReportMsg.textContent = `Atención: Se omitieron ${resumen.omitidos} registros por errores o datos faltantes.`;

                // Configurar descarga
                dom.btnDownloadErrors.onclick = () => {
                    _descargarCsv(result.csvErrorContent, `Errores_Importacion_${new Date().toISOString().slice(0, 10)}.csv`);
                };
            } else {
                dom.errorReportContainer.classList.add('d-none');
            }

            const detalles = result.detalles || [];

            const html = detalles.map(d => {
                let badgeClass = 'bg-secondary';
                let badgeText = 'DESCONOCIDO';

                if (d.valido) {
                    badgeClass = 'bg-success';
                    badgeText = '<i class="bi bi-check-circle me-1"></i>PROCESADO';
                } else {
                    // Distinguir entre omitido y error fatal si fuera necesario, 
                    // pero aqui todo lo no valido es omitido/error
                    badgeClass = 'bg-warning text-dark';
                    badgeText = '<i class="bi bi-exclamation-triangle me-1"></i>OMITIDO';
                }

                const badgeEstado = `<span class="badge ${badgeClass}">${badgeText}</span>`;

                const erroresHtml = d.errores && d.errores.length > 0
                    ? `<ul class="mb-0 text-danger ps-3">${d.errores.map(e => `<li>${e}</li>`).join('')}</ul>`
                    : '<span class="text-muted fst-italic">Sin observaciones</span>';

                return `
                    <tr>
                        <td class="fw-bold">${d.ref || '-'}</td>
                        <td>${d.comunicado || '-'}</td>
                        <td><small class="text-muted">UNK</small></td> 
                        <td class="text-end font-monospace text-muted">-</td>
                        <td><small class="text-muted">-</small></td>
                        <td class="text-center">${badgeEstado}</td>
                        <td class="small">${erroresHtml}</td>
                    </tr>
                `;
            }).join('');

            dom.previewBody.innerHTML = html;
        };

        const _descargarCsv = (base64Content, filename) => {
            const link = document.createElement('a');
            link.href = 'data:text/csv;base64,' + base64Content;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const _showLoader = (show, msg) => {
            if (show) {
                dom.loader.classList.remove('d-none');
                dom.loaderMsg.textContent = msg;
                dom.btnAnalizar.disabled = true;
                dom.dropZone.classList.add('d-none');
                dom.errorReportContainer.classList.add('d-none'); // Hide previous errors
            } else {
                dom.loader.classList.add('d-none');
                dom.btnAnalizar.disabled = false;
                dom.dropZone.classList.remove('d-none');
            }
        };

        const render = () => {
            return globalThis.TEMPLATES?.importacion || '';
        };

        const mount = (container) => {
            _cacheDom();
            _addEventListeners();
        };

        const _cacheDom = () => {
            dom.dropZone = document.getElementById('drop-zone');
            dom.fileInput = document.getElementById('file-input');
            dom.fileInfo = document.getElementById('file-info');
            dom.filenameDisplay = document.getElementById('filename-display');
            dom.btnAnalizar = document.getElementById('btn-analizar');
            dom.loader = document.getElementById('import-loader');
            dom.loaderMsg = document.getElementById('loader-msg');
            dom.previewContainer = document.getElementById('preview-container');
            dom.previewBody = document.getElementById('preview-body');
            dom.previewSummary = document.getElementById('preview-summary');

            // New elements
            dom.errorReportContainer = document.getElementById('error-report-container');
            dom.errorReportMsg = document.getElementById('error-report-msg');
            dom.btnDownloadErrors = document.getElementById('btn-download-errors');
        };

        return {
            render,
            mount,
            reset,
            analizar
        };
    })();
</script>