<script>
    /**
     * Componente ComunicadoDetalle
     * Vista detallada y completa para la gesti贸n de un comunicado individual.
     * VERSIN: 3.1 - Full Refactor & Fix
     */
    console.log(' ComunicadoDetalle.js cargado - Versi贸n 3.1');
    globalThis.ComunicadoDetalle = (() => {
        'use strict';

        // --- ESTADO LOCAL ---
        let state = {
            id: null,
            data: null,
            catalogs: {},
            loading: false,
            saving: false
        };

        // --- REFERENCIAS DOM ---
        let dom = {};

        // --- CONSTANTES ---
        const IVA_RATE = 0.16;

        /**
         * Inicializa el componente
         */
        async function init(container) {
            console.log('Iniciando ComunicadoDetalle v3.1...');

            _setGlobalLoader(true, 'Preparando entorno...');

            const storedId = sessionStorage.getItem('currentComunicadoId');
            if (!storedId) {
                console.warn('ID no encontrado. Volviendo al listado.');
                location.hash = '#/comunicados';
                return;
            }
            state.id = storedId;

            try {
                await _mount(container);
                _cacheDom();
                _bindEvents();

                _setGlobalLoader(true, 'Sincronizando datos...');
                await _loadData();

            } catch (error) {
                console.error('Error cr铆tico:', error);
                container.innerHTML = `<div class="alert alert-danger p-4">
                    <h4>Error de Carga</h4><p>${error.message}</p>
                    <button class="btn btn-outline-danger" onclick="location.reload()">Recargar</button>
                </div>`;
            } finally {
                _setGlobalLoader(false);
            }
        }

        const mount = async (container) => init(container);

        async function _mount(container) {
            container.innerHTML = '';
            let content = globalThis.TEMPLATES?.['comunicado_detalle'];
            if (!content) {
                const response = await serverCall('getTemplates', ['comunicado_detalle']);
                content = response?.comunicado_detalle;
            }
            if (!content) throw new Error('Plantilla no encontrada.');
            container.innerHTML = content;
        }

        function _cacheDom() {
            dom.headerTitle = document.getElementById('header-titulo');
            dom.headerSubtitle = document.getElementById('header-subtitulo');
            dom.btnVolver = document.getElementById('btn-volver-listado');
            dom.btnGuardar = document.getElementById('btn-guardar-todo');

            // General
            dom.genId = document.getElementById('gen-id');
            dom.genCuenta = document.getElementById('gen-cuenta') || document.getElementById('gen-referencia');
            dom.genAjustador = document.getElementById('gen-ajustador');
            dom.genFecha = document.getElementById('gen-fecha');
            dom.genComunicado = document.getElementById('gen-comunicado');
            dom.genDescripcion = document.getElementById('gen-descripcion');

            // Ubicaci贸n
            dom.genEstado = document.getElementById('gen-estado');
            dom.genDistrito = document.getElementById('gen-distrito');
            dom.genSiniestro = document.getElementById('gen-siniestro');
            dom.genFenomeno = document.getElementById('gen-fenomeno');
            dom.genFi = document.getElementById('gen-fi');
            dom.genFondo = document.getElementById('gen-fondo');
            dom.dropdownSiniestro = document.getElementById('dropdown-gen-siniestro-list');
            dom.dropdownDistrito = document.getElementById('dropdown-gen-distrito-list');

            dom.avisos = {
                siniestro: document.getElementById('aviso-gen-siniestro'),
                distrito: document.getElementById('aviso-gen-distrito')
            };

            // Financiero
            dom.financiero = {
                body: document.getElementById('lista-estimaciones-body'),
                btnAdd: document.getElementById('btn-add-estimacion'),
                resumen: {
                    autorizado: document.getElementById('fin-autorizado'),
                    ejercido: document.getElementById('fin-ejercido'),
                    porEjercer: document.getElementById('fin-por-ejercer')
                }
            };

            // Presupuesto
            dom.presupuesto = {
                body: document.getElementById('tabla-presupuesto-body'),
                btnAdd: document.getElementById('btn-add-actualizacion')
            };

            // Equipo
            dom.equipo = {
                listContratistas: document.getElementById('lista-contratistas'),
                listSupervisores: document.getElementById('lista-supervisores'),
                btnAddContratista: document.getElementById('btn-add-contratista'),
                btnAddSupervisor: document.getElementById('btn-add-supervisor')
            };

            // Tickets
            dom.tickets = {
                list: document.getElementById('lista-tickets'),
                btnAdd: document.getElementById('btn-add-ticket')
            };
        }

        function _bindEvents() {
            dom.btnVolver?.addEventListener('click', () => location.hash = '#/comunicados');
            dom.btnGuardar?.addEventListener('click', _guardarTodo);
            dom.presupuesto.btnAdd?.addEventListener('click', _addActualizacionPresupuesto);
            dom.financiero.btnAdd?.addEventListener('click', _addEstimacion);
            dom.equipo.btnAddContratista?.addEventListener('click', () => _addEquipo('contratista'));
            dom.equipo.btnAddSupervisor?.addEventListener('click', () => _addEquipo('supervisor'));
            dom.tickets.btnAdd?.addEventListener('click', _addTicket);
        }

        async function _loadData() {
            try {
                const catalogsResponse = await serverCall('getComunicadoCatalogs');
                if (catalogsResponse?.success) {
                    state.catalogs = catalogsResponse.data;
                    _poblarCatalogosUI();
                }
                const dataResponse = await serverCall('getComunicadoCompleto', state.id);
                if (dataResponse) {
                    state.data = _sanitizeData(dataResponse);
                    _renderData();
                }
            } catch (e) {
                console.error(e);
                alert('Error al cargar: ' + e.message);
            }
        }

        function _sanitizeData(d) {
            return {
                ...d,
                presupuesto: d.presupuesto || [],
                equipo: d.equipo || [],
                tickets: d.tickets || [],
                financiero: Array.isArray(d.financiero) ? d.financiero : (d.financiero?.estimaciones || [])
            };
        }

        function _poblarCatalogosUI() {
            if (dom.genEstado && state.catalogs.estados) {
                dom.genEstado.innerHTML = '<option value="">Seleccione...</option>';
                state.catalogs.estados.forEach(est => {
                    const opt = document.createElement('option');
                    opt.value = est.id;
                    opt.textContent = est.estado || est.nombre;
                    dom.genEstado.appendChild(opt);
                });
            }
            _setupCombobox(dom.genSiniestro, dom.dropdownSiniestro, state.catalogs.siniestros || [], 'siniestro',
                (item) => { dom.genSiniestro.value = item.siniestro; _onSiniestroChange(item); }
            );
            _setupCombobox(dom.genDistrito, dom.dropdownDistrito, state.catalogs.distritosRiego || [], 'distritoRiego',
                (item) => dom.genDistrito.value = item.distritoRiego
            );
        }

        function _renderData() {
            const d = state.data;

            // Header
            dom.headerTitle.textContent = d.comunicado || 'Nuevo Comunicado';
            // Mapeo: Referencia (antes Cuenta)
            const referencia = d.referencia || d.cuenta?.referencia || d.cuenta?.cuenta || 'Sin Referencia';
            dom.headerSubtitle.textContent = `ID: ${d.id} | Ref: ${referencia}`;

            // Datos Generales
            dom.genId.value = d.id || '';

            // Referencia (buscar por ID original o alternativo)
            const inputReferencia = dom.genCuenta || document.getElementById('gen-referencia');
            if (inputReferencia) {
                inputReferencia.value = referencia;
            }

            // AJUSTADOR (Solo Lectura - Heredado de Cuenta)
            // Backend ahora env铆a d.ajustador = { id, nombre }
            const nombreAjustador = d.ajustador?.nombre || d.ajustadorNombre || 'Sin Ajustador Asignado';

            if (dom.genAjustador) {
                if (dom.genAjustador.tagName === 'SELECT') {
                    // Si qued贸 como select, lo forzamos a mostrar solo el valor actual
                    dom.genAjustador.innerHTML = `<option selected>${nombreAjustador}</option>`;
                    dom.genAjustador.disabled = true;
                } else {
                    dom.genAjustador.value = nombreAjustador;
                    dom.genAjustador.readOnly = true;
                }
                dom.genAjustador.classList.add('bg-light', 'text-dark', 'fw-bold');
            }

            dom.genFecha.value = _formatDateISO(d.fecha);
            dom.genComunicado.value = d.comunicado || '';
            dom.genDescripcion.value = d.descripcion || '';
            if (d.idEstado) dom.genEstado.value = d.idEstado;
            _setComboboxValue(dom.genDistrito, d.distrito, 'distritoRiego');
            _setComboboxValue(dom.genSiniestro, d.siniestro, 'siniestro');
            if (d.siniestro) _onSiniestroChange(d.siniestro);

            _renderPresupuesto();
            _renderEquipo();
            _renderFinanciero();
            _renderTickets();
        }

        // --- FINANCIERO (Unificado) ---
        function _renderFinanciero() {
            const tbody = dom.financiero.body;
            if (!tbody) return;
            tbody.innerHTML = '';
            const items = state.data.financiero || [];

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted"><small>No hay estimaciones definidas.</small></td></tr>`;
            } else {
                items.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    const ejecutado = parseFloat(item.montoEjecutado) || 0;
                    const amortizacion = parseFloat(item.amortizacion) || 0;
                    const subtotal = ejecutado - amortizacion;
                    const iva = subtotal * IVA_RATE;
                    const total = subtotal + iva;

                    tr.innerHTML = `
                        <td><input type="text" class="form-control form-control-sm" value="${item.numero || ''}" placeholder="#" onchange="ComunicadoDetalle.updateFinanciero(${index}, 'numero', this.value)"></td>
                        <td><input type="date" class="form-control form-control-sm" value="${_formatDateISO(item.fecha)}" onchange="ComunicadoDetalle.updateFinanciero(${index}, 'fecha', this.value)"></td>
                        <td><input type="text" class="form-control form-control-sm text-end currency-input" value="${_formatCurrency(item.montoEjecutado)}" onchange="ComunicadoDetalle.updateFinanciero(${index}, 'montoEjecutado', this.value)"></td>
                        <td><input type="text" class="form-control form-control-sm text-end currency-input text-danger" value="${_formatCurrency(item.amortizacion)}" onchange="ComunicadoDetalle.updateFinanciero(${index}, 'amortizacion', this.value)"></td>
                        <td><div class="form-control form-control-sm text-end bg-light fw-bold">${_formatCurrency(subtotal)}</div></td>
                        <td><div class="form-control form-control-sm text-end bg-light text-muted">${_formatCurrency(iva)}</div></td>
                        <td><input type="text" class="form-control form-control-sm text-end fw-bold text-success" value="${_formatCurrency(item.totalFacturado || total)}" readonly></td>
                        <td><input type="text" class="form-control form-control-sm" value="${item.folioFactura || ''}" placeholder="Folio XML" onchange="ComunicadoDetalle.updateFinanciero(${index}, 'folioFactura', this.value)"></td>
                        <td class="text-center"><button class="btn btn-link text-danger btn-sm p-0" onclick="ComunicadoDetalle.removeFinanciero(${index})"><i class="bi bi-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            _attachCurrencyFormatters();
            _updateResumenFinanciero();
        }

        function _addEstimacion() {
            state.data.financiero.push({ numero: '', fecha: new Date().toISOString(), montoEjecutado: 0, amortizacion: 0 });
            _renderFinanciero();
        }

        function _updateResumenFinanciero() {
            const items = state.data.financiero || [];
            const presItems = state.data.presupuesto || [];
            const autorizado = presItems.length > 0 ? (parseFloat(presItems[presItems.length - 1].monto) || 0) : 0;
            const ejercido = items.reduce((sum, item) => sum + (parseFloat(item.montoEjecutado) || 0), 0);
            const saldo = autorizado - ejercido; // Saldo real de obra

            if (dom.financiero.resumen.autorizado) dom.financiero.resumen.autorizado.textContent = _formatCurrency(autorizado);
            if (dom.financiero.resumen.ejercido) dom.financiero.resumen.ejercido.textContent = _formatCurrency(ejercido);
            if (dom.financiero.resumen.porEjercer) {
                dom.financiero.resumen.porEjercer.textContent = _formatCurrency(saldo);
                dom.financiero.resumen.porEjercer.className = `fs-5 fw-bold ${saldo < 0 ? 'text-danger' : 'text-success'}`;
            }
        }

        // --- EQUIPO ---
        function _renderEquipo() {
            if (!dom.equipo.listContratistas) return;
            dom.equipo.listContratistas.innerHTML = '';
            dom.equipo.listSupervisores.innerHTML = '';

            const equipo = state.data.equipo || [];

            // Helper para renderizar items
            const renderItem = (item, type, container) => {
                const realIndex = equipo.indexOf(item);
                const div = document.createElement('div');
                div.className = 'list-group-item d-flex justify-content-between align-items-center mb-2 shadow-sm border';
                div.innerHTML = `
                    <div class="flex-grow-1 me-3">
                        <input type="text" class="form-control form-control-sm border-0 fw-bold mb-1" placeholder="Nombre..." 
                            value="${item.nombre || ''}" onchange="ComunicadoDetalle.updateEquipo(${realIndex}, 'nombre', this.value)">
                        <input type="text" class="form-control form-control-sm border-0 text-muted small" placeholder="Detalles / Cargo..." 
                            value="${item.detalles || ''}" onchange="ComunicadoDetalle.updateEquipo(${realIndex}, 'detalles', this.value)">
                    </div>
                    <button class="btn btn-outline-danger btn-sm border-0" onclick="ComunicadoDetalle.removeEquipo(${realIndex})"><i class="bi bi-x-lg"></i></button>
                `;
                container.appendChild(div);
            };

            equipo.filter(e => e.tipo === 'contratista').forEach(e => renderItem(e, 'contratista', dom.equipo.listContratistas));
            equipo.filter(e => e.tipo === 'supervisor').forEach(e => renderItem(e, 'supervisor', dom.equipo.listSupervisores));

            if (dom.equipo.listContratistas.children.length === 0) dom.equipo.listContratistas.innerHTML = '<div class="text-center text-muted small py-2">Sin contratistas.</div>';
            if (dom.equipo.listSupervisores.children.length === 0) dom.equipo.listSupervisores.innerHTML = '<div class="text-center text-muted small py-2">Sin supervisores.</div>';
        }

        function _addEquipo(tipo) {
            state.data.equipo.push({ tipo, nombre: '', detalles: '' });
            _renderEquipo();
        }

        // --- TICKETS ---
        function _renderTickets() {
            if (!dom.tickets.list) return;
            dom.tickets.list.innerHTML = '';
            const tickets = state.data.tickets || [];

            if (tickets.length === 0) {
                dom.tickets.list.innerHTML = '<div class="text-center text-muted py-3">No hay tickets registrados.</div>';
                return;
            }

            tickets.forEach((t, idx) => {
                const div = document.createElement('div');
                div.className = 'card mb-2 shadow-sm border-0';
                div.innerHTML = `
                    <div class="card-body p-2 d-flex gap-2 align-items-center">
                        <input type="text" class="form-control form-control-sm" style="width:100px" placeholder="# Ticket" value="${t.numero || ''}" onchange="ComunicadoDetalle.updateTicket(${idx},'numero',this.value)">
                        <input type="date" class="form-control form-control-sm" style="width:130px" value="${_formatDateISO(t.fecha)}" onchange="ComunicadoDetalle.updateTicket(${idx},'fecha',this.value)">
                        <input type="text" class="form-control form-control-sm flex-grow-1" placeholder="Asunto / Descripci贸n" value="${t.asunto || ''}" onchange="ComunicadoDetalle.updateTicket(${idx},'asunto',this.value)">
                        <select class="form-select form-select-sm" style="width:120px" onchange="ComunicadoDetalle.updateTicket(${idx},'estado',this.value)">
                            <option value="Abierto" ${t.estado === 'Abierto' ? 'selected' : ''}>Abierto</option>
                            <option value="Cerrado" ${t.estado === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                            <option value="Pendiente" ${t.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                        </select>
                         <button class="btn btn-sm text-danger" onclick="ComunicadoDetalle.removeTicket(${idx})"><i class="bi bi-trash"></i></button>
                    </div>
                `;
                dom.tickets.list.appendChild(div);
            });
        }

        function _addTicket() {
            state.data.tickets.push({ numero: '', fecha: new Date().toISOString(), asunto: '', estado: 'Abierto' });
            _renderTickets();
        }

        // --- PUBLIC HELPERS (Exports) ---
        function updateFinanciero(index, field, value) {
            const item = state.data.financiero[index];
            if (!item) return;
            if (['montoEjecutado', 'amortizacion'].includes(field)) {
                item[field] = parseFloat(String(value).replace(/,/g, '')) || 0;
            } else {
                item[field] = value;
            }
            // Rec谩lculo del Total Facturado
            const sub = (parseFloat(item.montoEjecutado) || 0) - (parseFloat(item.amortizacion) || 0);
            item.totalFacturado = sub * (1 + IVA_RATE);
            _renderFinanciero();
        }

        function removeFinanciero(index) {
            if (confirm('驴Eliminar registro financiero?')) {
                state.data.financiero.splice(index, 1);
                _renderFinanciero();
            }
        }

        function updatePresupuesto(idx, field, val) {
            const item = state.data.presupuesto[idx];
            if (field === 'monto') item[field] = parseFloat(val.replace(/,/g, '')) || 0;
            else item[field] = val;
            _renderPresupuesto();
        }
        function removePresupuesto(idx) { state.data.presupuesto.splice(idx, 1); _renderPresupuesto(); }

        function updateEquipo(idx, field, val) { state.data.equipo[idx][field] = val; }
        function removeEquipo(idx) { state.data.equipo.splice(idx, 1); _renderEquipo(); }

        function updateTicket(idx, field, val) { state.data.tickets[idx][field] = val; }
        function removeTicket(idx) { state.data.tickets.splice(idx, 1); _renderTickets(); }

        // --- AUXILIARES ---
        function _attachCurrencyFormatters() {
            document.querySelectorAll('.currency-input').forEach(input => {
                input.addEventListener('blur', (e) => {
                    const val = parseFloat(e.target.value.replace(/,/g, '')) || 0;
                    e.target.value = _formatCurrency(val, false);
                });
                input.addEventListener('focus', (e) => {
                    e.target.value = e.target.value.replace(/,/g, '').replace('$', '');
                    e.target.select();
                });
            });
        }
        function _formatCurrency(val, withSymbol = true) {
            const num = parseFloat(val) || 0;
            return (withSymbol ? '$' : '') + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        function _formatDateISO(dateStr) {
            if (!dateStr) return '';
            try { return new Date(dateStr).toISOString().split('T')[0]; } catch (e) { return ''; }
        }
        function _setComboboxValue(input, obj, prop) {
            const val = (obj && typeof obj === 'object') ? obj[prop] : (obj || '');
            input.value = val || '';
        }
        function _setupCombobox(input, dropdown, items, keyProp, onSelect) {
            if (!input || !dropdown) return;
            const renderList = (filter = '') => {
                dropdown.innerHTML = '';
                const term = filter.toLowerCase();
                const filtered = items.filter(i => (i[keyProp] || i.nombre || '').toLowerCase().includes(term));
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<li class="dropdown-item text-muted disabled">Sin resultados</li>';
                } else {
                    filtered.forEach(item => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item';
                        a.href = '#';
                        a.textContent = item[keyProp] || item.nombre;
                        a.onclick = (e) => { e.preventDefault(); onSelect(item); };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });
                }
            };
            input.addEventListener('input', () => {
                renderList(input.value);
                new bootstrap.Dropdown(input).show();
                if (dom.avisos[keyProp]) {
                    const exactMatch = items.some(i => (i[keyProp] || '').toLowerCase() === input.value.toLowerCase());
                    dom.avisos[keyProp].classList.toggle('d-none', exactMatch || !input.value);
                }
            });
            input.addEventListener('focus', () => renderList(input.value));
        }

        function _onSiniestroChange(itemOrString) {
            const fields = [dom.genFenomeno, dom.genFi, dom.genFondo];
            const isObj = typeof itemOrString === 'object' && itemOrString !== null;
            if (isObj) {
                dom.genFenomeno.value = itemOrString.fenomeno || '';
                dom.genFi.value = itemOrString.fi || '';
                dom.genFondo.value = itemOrString.fondo || '';
                fields.forEach(f => { if (f) f.disabled = true; });
                if (dom.avisos.siniestro) dom.avisos.siniestro.classList.add('d-none');
            } else {
                fields.forEach(f => { if (f) { f.disabled = false; f.value = ''; } });
            }
        }

        function _renderPresupuesto() {
            const tbody = dom.presupuesto.body;
            if (!tbody) return;
            tbody.innerHTML = '';
            const items = state.data.presupuesto || [];
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sin presupuesto.</td></tr>';
            } else {
                items.forEach((item, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                           <td>${idx === 0 ? '<span class="badge bg-secondary">Origen</span>' : `<input class="form-control form-control-sm" value="${item.revision || ''}" onchange="ComunicadoDetalle.updatePresupuesto(${idx},'revision',this.value)">`}</td>
                           <td><input type="date" class="form-control form-control-sm" value="${_formatDateISO(item.fecha)}" onchange="ComunicadoDetalle.updatePresupuesto(${idx},'fecha',this.value)"></td>
                           <td><input type="text" class="form-control form-control-sm text-end currency-input" value="${_formatCurrency(item.monto)}" onchange="ComunicadoDetalle.updatePresupuesto(${idx},'monto',this.value)"></td>
                           <td class="text-center"><button class="btn btn-sm btn-link text-danger" onclick="ComunicadoDetalle.removePresupuesto(${idx})"><i class="bi bi-trash"></i></button></td>
                       `;
                    tbody.appendChild(tr);
                });
            }
            _updateResumenFinanciero();
            _attachCurrencyFormatters();
        }
        function _addActualizacionPresupuesto() {
            state.data.presupuesto.push({ revision: '', fecha: new Date().toISOString(), monto: 0 });
            _renderPresupuesto();
        }

        async function _guardarTodo() {
            if (state.saving) return;
            state.saving = true;
            dom.btnGuardar.disabled = true;
            dom.btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
            try {
                const payload = {
                    comunicado: dom.genComunicado.value,
                    fecha: dom.genFecha.value,
                    descripcion: dom.genDescripcion.value,
                    idEstado: dom.genEstado.value,
                    distrito: dom.genDistrito.value,
                    siniestro: dom.genSiniestro.value,
                    presupuesto: state.data.presupuesto,
                    equipo: state.data.equipo,
                    financiero: state.data.financiero,
                    tickets: state.data.tickets
                };
                await serverCall('updateComunicado', state.id, payload);
                alert('Guardado exitosamente.');
                await _loadData();
            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
            } finally {
                state.saving = false;
                dom.btnGuardar.disabled = false;
                dom.btnGuardar.innerHTML = '<i class="bi bi-save"></i> Guardar Cambios';
            }
        }

        function _setGlobalLoader(isLoading, msg) {
            const l = document.getElementById('app-loader');
            if (l) {
                l.classList.toggle('d-none', !isLoading);
                const m = document.getElementById('app-loader-message');
                if (m) m.textContent = msg;
            }
        }

        return {
            init,
            updateFinanciero, removeFinanciero,
            updatePresupuesto, removePresupuesto,
            updateEquipo, removeEquipo,
            updateTicket, removeTicket
        };

    })();
</script>