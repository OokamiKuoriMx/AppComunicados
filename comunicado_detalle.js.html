<script>
    /**
     * Componente ComunicadoDetalle
     * Vista detallada y completa para la gesti√≥n de un comunicado individual.
     * VERSI√ìN: 2024-12-12 v3 - Reingenier√≠a Financiera (Referencia + Ajustador + Modelo Estimaciones)
     * 
     * MEJORAS APLICADAS:
     * 1. Reingenier√≠a de conceptos: Cuenta -> Referencia + Ajustador
     * 2. Modelo Financiero corregido con desglose de estimaciones
     * 3. Formateo de moneda visual (comas de miles)
     * 4. Validaci√≥n de cat√°logos con confirmaci√≥n bloqueante
     */
    console.log('üì¶ ComunicadoDetalle.js cargado - Versi√≥n 2024-12-12 v3 (Reingenier√≠a)');
    globalThis.ComunicadoDetalle = (() => {
        'use strict';

        // ===== CONSTANTES DE CONFIGURACI√ìN =====
        const AJUSTADORES = {
            'CTA': 'Charles Taylor Adjusting (CTA)',
            'McLarens': 'McLarens M√©xico',
            'Crawford': 'Crawford & Company',
            'Seguritech': 'Seguritech Ajustadores',
            'Otro': 'Otro'
        };

        const IVA_RATE = 0.16; // 16% IVA M√©xico

        // ===== ESTADO LOCAL =====
        let state = {
            id: null,
            data: null,
            catalogs: {},
            loading: false,
            saving: false
        };

        // Referencias DOM
        let dom = {};

        // ===== UTILIDADES DE FORMATEO =====

        /**
         * Formatea un n√∫mero como moneda mexicana con comas de miles
         * @param {number} value - Valor num√©rico
         * @param {boolean} includeSymbol - Incluir s√≠mbolo $
         * @returns {string} Valor formateado
         */
        function _formatCurrency(value, includeSymbol = true) {
            const num = parseFloat(value) || 0;
            const formatted = num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return includeSymbol ? `$${formatted}` : formatted;
        }

        /**
         * Parsea un string de moneda a n√∫mero
         * @param {string} value - Valor con formato de moneda
         * @returns {number} Valor num√©rico
         */
        function _parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            // Remover $, comas y espacios
            const cleaned = String(value).replace(/[$,\s]/g, '');
            return parseFloat(cleaned) || 0;
        }

        /**
         * Configura un input para mostrar formato de moneda visual
         * @param {HTMLInputElement} input - El input a configurar
         */
        function _setupCurrencyInput(input) {
            if (!input) return;

            // Al perder foco: mostrar formateado
            input.addEventListener('blur', function () {
                const value = _parseCurrency(this.value);
                if (value > 0) {
                    this.value = _formatCurrency(value, false);
                }
            });

            // Al ganar foco: mostrar n√∫mero limpio
            input.addEventListener('focus', function () {
                const value = _parseCurrency(this.value);
                this.value = value > 0 ? value.toString() : '';
                this.select();
            });
        }

        // ===== INICIALIZACI√ìN =====

        async function init(container) {
            console.log('Iniciando ComunicadoDetalle v3...');

            // 0. Mostrar loader INMEDIATAMENTE
            const loader = document.getElementById('app-loader');
            if (loader) {
                const loaderTitle = document.getElementById('app-loader-title');
                const loaderMessage = document.getElementById('app-loader-message');
                if (loaderTitle) loaderTitle.textContent = 'Cargando Comunicado';
                if (loaderMessage) loaderMessage.textContent = 'Preparando vista...';
                loader.classList.remove('d-none');
                console.log('üîÑ Loader mostrado INMEDIATAMENTE');
            }

            // 1. Verificar ID en sessionStorage
            const storedId = sessionStorage.getItem('currentComunicadoId');
            if (!storedId) {
                console.warn('No se encontr√≥ ID de comunicado. Redirigiendo al listado.');
                location.hash = '#/comunicados';
                return;
            }
            state.id = storedId;

            // 2. Cargar Template
            await _mount(container);

            // 3. Cachear DOM y Bindear Eventos
            _cacheDom();
            _bindEvents();

            // 3.5. Actualizar mensaje del loader
            const loaderMessage = document.getElementById('app-loader-message');
            if (loaderMessage) loaderMessage.textContent = 'Obteniendo informaci√≥n detallada...';

            // 4. Cargar Datos
            await _loadData();
        }

        const mount = async (container) => init(container);

        async function _mount(container) {
            try {
                container.innerHTML = '';
                console.log('üßπ Contenedor limpiado');

                let templateContent = null;
                if (globalThis.TEMPLATES && globalThis.TEMPLATES['comunicado_detalle']) {
                    templateContent = globalThis.TEMPLATES['comunicado_detalle'];
                } else {
                    console.warn('Template no encontrado en cach√©, solicitando al servidor...');
                    const html = await serverCall('getTemplates', ['comunicado_detalle']);
                    if (html && html.comunicado_detalle) {
                        templateContent = html.comunicado_detalle;
                    }
                }

                if (templateContent) {
                    container.innerHTML = templateContent;
                    console.log('‚úÖ Template montado');
                } else {
                    throw new Error('No se pudo cargar la plantilla comunicado_detalle');
                }
            } catch (error) {
                console.error('Error montando template:', error);
                container.innerHTML = `<div class="alert alert-danger">Error cargando la vista: ${error.message}</div>`;
                throw error;
            }
        }

        function _cacheDom() {
            dom.headerTitle = document.getElementById('header-titulo');
            dom.headerSubtitle = document.getElementById('header-subtitulo');
            dom.headerStatus = document.getElementById('header-status');
            dom.btnVolver = document.getElementById('btn-volver-listado');
            dom.btnGuardar = document.getElementById('btn-guardar-todo');

            // Inputs Generales - REFACTORIZADO
            dom.genId = document.getElementById('gen-id');
            dom.genReferencia = document.getElementById('gen-referencia'); // Antes: gen-cuenta
            dom.genAjustador = document.getElementById('gen-ajustador');   // NUEVO
            dom.genAjustadorOtro = document.getElementById('gen-ajustador-otro'); // NUEVO
            dom.genFecha = document.getElementById('gen-fecha');
            dom.genComunicado = document.getElementById('gen-comunicado');
            dom.genDescripcion = document.getElementById('gen-descripcion');
            dom.genEstado = document.getElementById('gen-estado');
            dom.genDistrito = document.getElementById('gen-distrito');
            dom.genSiniestro = document.getElementById('gen-siniestro');

            dom.genFenomeno = document.getElementById('gen-fenomeno');
            dom.genFondo = document.getElementById('gen-fondo');
            dom.genFi = document.getElementById('gen-fi');

            // Comboboxes (Listas y Avisos)
            dom.dropdownSiniestro = document.getElementById('dropdown-gen-siniestro-list');
            dom.avisoSiniestro = document.getElementById('aviso-gen-siniestro');

            dom.dropdownDistrito = document.getElementById('dropdown-gen-distrito-list');
            dom.avisoDistrito = document.getElementById('aviso-gen-distrito');

            // Avisos Fen√≥meno/FI/Fondo
            dom.avisoFenomeno = document.getElementById('aviso-gen-fenomeno');
            dom.avisoFi = document.getElementById('aviso-gen-fi');
            dom.avisoFondo = document.getElementById('aviso-gen-fondo');

            // Presupuesto
            dom.presupuestoBody = document.getElementById('tabla-presupuesto-body');
            dom.totalAutorizado = document.getElementById('presupuesto-total-autorizado');
            dom.totalCapturado = document.getElementById('presupuesto-total-capturado');
            dom.btnAddActualizacion = document.getElementById('btn-add-actualizacion');

            // Equipo
            dom.btnAddContratista = document.getElementById('btn-add-contratista');
            dom.btnAddSupervisor = document.getElementById('btn-add-supervisor');
            dom.listaContratistas = document.getElementById('lista-contratistas');
            dom.listaSupervisores = document.getElementById('lista-supervisores');

            // Financiero - REFACTORIZADO
            dom.btnAddEstimacion = document.getElementById('btn-add-estimacion');
            dom.listaEstimaciones = document.getElementById('lista-estimaciones');

            // Totales de estimaciones
            dom.totalEjecutado = document.getElementById('total-ejecutado');
            dom.totalAmortizacion = document.getElementById('total-amortizacion');
            dom.totalSubtotal = document.getElementById('total-subtotal');
            dom.totalIva = document.getElementById('total-iva');
            dom.totalFacturado = document.getElementById('total-facturado');

            // Resumen Financiero
            dom.finAutorizado = document.getElementById('fin-autorizado');
            dom.finEjercido = document.getElementById('fin-ejercido');
            dom.finPorEjercer = document.getElementById('fin-por-ejercer');
            dom.finFacturado = document.getElementById('fin-facturado');
            dom.finPorcentaje = document.getElementById('fin-porcentaje');
            dom.finProgressBar = document.getElementById('fin-progress-bar');
            dom.finAjustadorInfo = document.getElementById('fin-ajustador-info');

            // Tickets
            dom.btnAddTicket = document.getElementById('btn-add-ticket');
            dom.listaTickets = document.getElementById('lista-tickets');

            // Actualizaciones
            dom.listaActualizaciones = document.getElementById('lista-actualizaciones');
        }

        function _bindEvents() {
            if (dom.btnVolver) {
                dom.btnVolver.addEventListener('click', () => {
                    location.hash = '#/comunicados';
                });
            }

            if (dom.btnGuardar) {
                dom.btnGuardar.addEventListener('click', _guardarTodo);
            }

            // Mostrar/ocultar campo "Otro" ajustador
            if (dom.genAjustador) {
                dom.genAjustador.addEventListener('change', () => {
                    if (dom.genAjustadorOtro) {
                        if (dom.genAjustador.value === 'Otro') {
                            dom.genAjustadorOtro.classList.remove('d-none');
                            dom.genAjustadorOtro.focus();
                        } else {
                            dom.genAjustadorOtro.classList.add('d-none');
                            dom.genAjustadorOtro.value = '';
                        }
                    }
                });
            }

            // Presupuesto
            if (dom.btnAddActualizacion) dom.btnAddActualizacion.addEventListener('click', _addActualizacionPresupuesto);

            // Equipo
            if (dom.btnAddContratista) dom.btnAddContratista.addEventListener('click', () => _addEquipo('contratista'));
            if (dom.btnAddSupervisor) dom.btnAddSupervisor.addEventListener('click', () => _addEquipo('supervisor'));

            // Financiero
            if (dom.btnAddEstimacion) dom.btnAddEstimacion.addEventListener('click', _addEstimacion);

            // Tickets
            if (dom.btnAddTicket) dom.btnAddTicket.addEventListener('click', _addTicket);
        }

        // ===== CARGA DE DATOS =====

        async function _loadData() {
            console.log('üì• Cargando datos del comunicado...');
            try {
                // Cargar cat√°logos primero si no existen
                const catalogsResponse = await serverCall('getComunicadoCatalogs');
                if (catalogsResponse) {
                    state.catalogs = catalogsResponse;
                    _poblarCatalogos();
                }

                // Cargar detalle del comunicado
                const detalleResponse = await serverCall('getComunicadoCompleto', state.id);
                if (detalleResponse) {
                    state.data = detalleResponse;

                    // Asegurar estructuras de datos
                    if (!state.data.presupuesto) state.data.presupuesto = [];
                    if (!state.data.equipo) state.data.equipo = [];

                    // NUEVO: Estructura financiera mejorada
                    if (!state.data.financiero) state.data.financiero = {};
                    if (!state.data.financiero.estimaciones) state.data.financiero.estimaciones = [];

                    if (!state.data.tickets) state.data.tickets = [];

                    _renderData();
                }

            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar los datos del comunicado: ' + error.message);
            } finally {
                _setLoading(false);
            }
        }

        function _setLoading(isLoading) {
            state.loading = isLoading;

            const loader = document.getElementById('app-loader');
            const loaderTitle = document.getElementById('app-loader-title');
            const loaderMessage = document.getElementById('app-loader-message');
            const content = document.getElementById('detalle-content');

            console.log(`üîÑ _setLoading(${isLoading})`);

            if (loader) {
                if (isLoading) {
                    if (loaderTitle) loaderTitle.textContent = 'Cargando Comunicado';
                    if (loaderMessage) loaderMessage.textContent = 'Obteniendo informaci√≥n detallada...';
                    loader.classList.remove('d-none');

                    if (content) {
                        content.classList.add('d-none');
                    }
                } else {
                    loader.classList.add('d-none');

                    if (content) {
                        content.classList.remove('d-none');
                        content.classList.add('d-flex', 'flex-column', 'h-100');
                    }
                }
            }

            if (dom.headerTitle) {
                dom.headerTitle.textContent = isLoading ? 'Cargando...' : (state.data?.comunicado || 'Nuevo Comunicado');
            }
        }

        function _poblarCatalogos() {
            // Estados
            if (dom.genEstado && state.catalogs.estados) {
                dom.genEstado.innerHTML = '<option value="">Seleccione...</option>';
                state.catalogs.estados.forEach(est => {
                    const opt = document.createElement('option');
                    const id = est.id || est.idEstado;
                    opt.value = id;
                    opt.textContent = est.estado || est.nombre;
                    dom.genEstado.appendChild(opt);
                });
            }

            // Configurar Combobox Siniestros
            if (state.catalogs.siniestros) {
                _setupCombobox(
                    dom.genSiniestro,
                    dom.dropdownSiniestro,
                    state.catalogs.siniestros,
                    (item) => {
                        dom.genSiniestro.value = item.siniestro || item.nombre;
                        _actualizarDetallesSiniestro();
                    }
                );
            }

            // Configurar Combobox Distritos
            if (state.catalogs.distritosRiego) {
                _setupCombobox(
                    dom.genDistrito,
                    dom.dropdownDistrito,
                    state.catalogs.distritosRiego,
                    (item) => {
                        dom.genDistrito.value = item.distritoRiego || item.nombre;
                        _verificarNuevoRegistro('distrito');
                    }
                );
            }
        }

        /**
         * Configura un combobox h√≠brido (input + dropdown) con validaci√≥n bloqueante
         */
        function _setupCombobox(input, dropdownList, items, onSelectCallback) {
            if (!input || !dropdownList) return;

            const poblarLista = (filtro = '') => {
                dropdownList.innerHTML = '';
                const filtroLower = String(filtro).toLowerCase();

                const filtrados = items.filter(item => {
                    const val = String(item.siniestro || item.distritoRiego || item.nombre || '').toLowerCase();
                    return val.includes(filtroLower);
                });

                if (filtrados.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'dropdown-item text-muted disabled';
                    li.textContent = 'No hay coincidencias';
                    dropdownList.appendChild(li);
                } else {
                    filtrados.forEach(item => {
                        const valor = String(item.siniestro || item.distritoRiego || item.nombre || '');
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item';
                        a.href = '#';
                        a.textContent = valor;
                        a.onclick = (e) => {
                            e.preventDefault();
                            if (onSelectCallback) onSelectCallback(item);
                        };
                        li.appendChild(a);
                        dropdownList.appendChild(li);
                    });
                }
            };

            // Eventos del Input
            input.addEventListener('input', () => {
                const valor = input.value;
                poblarLista(valor);

                if (valor.length > 0) {
                    const dropdown = new bootstrap.Dropdown(input);
                    dropdown.show();
                }

                if (input === dom.genSiniestro) _actualizarDetallesSiniestro();
                if (input === dom.genDistrito) _verificarNuevoRegistro('distrito');
            });

            input.addEventListener('focus', () => {
                poblarLista(input.value);
            });

            // MEJORA: Validaci√≥n bloqueante al perder el foco
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    _validarCatalogoConConfirmacion(input, items);
                }, 200);
            });
        }

        /**
         * MEJORA 3: Validaci√≥n bloqueante para evitar registros basura
         */
        function _validarCatalogoConConfirmacion(input, items) {
            if (!input || !input.value.trim()) return;

            const valor = input.value.trim();
            const tipo = input === dom.genSiniestro ? 'siniestro' :
                (input === dom.genDistrito ? 'distrito' : null);

            if (!tipo) return;

            const valoresUnicos = items.map(item =>
                String(item.siniestro || item.distritoRiego || item.nombre || '').toLowerCase().trim()
            );

            const existe = valoresUnicos.includes(valor.toLowerCase());

            if (!existe && valor.length > 0) {
                // Mostrar confirmaci√≥n bloqueante
                const mensaje = tipo === 'siniestro'
                    ? `‚ö†Ô∏è ATENCI√ìN: El siniestro "${valor}" NO existe en el cat√°logo.\n\n¬øEst√° seguro de crear un NUEVO siniestro?\n\nSi fue un error de escritura, presione "Cancelar" y corrija el valor.`
                    : `‚ö†Ô∏è ATENCI√ìN: El distrito "${valor}" NO existe en el cat√°logo.\n\n¬øEst√° seguro de crear un NUEVO distrito?\n\nSi fue un error de escritura, presione "Cancelar" y corrija el valor.`;

                if (!confirm(mensaje)) {
                    // Si cancela, limpiar el campo
                    input.value = '';
                    input.focus();

                    if (tipo === 'siniestro') {
                        _actualizarDetallesSiniestro();
                    }
                }
            }
        }

        function _verificarNuevoRegistro(tipo) {
            let input, aviso, valoresUnicos;

            if (tipo === 'distrito') {
                input = dom.genDistrito;
                aviso = dom.avisoDistrito;
                valoresUnicos = (state.catalogs.distritosRiego || []).map(d => String(d.distritoRiego || d.nombre || '').toLowerCase().trim());
            } else if (tipo === 'siniestro') {
                input = dom.genSiniestro;
                aviso = dom.avisoSiniestro;
                valoresUnicos = (state.catalogs.siniestros || []).map(s => String(s.siniestro || s.nombre || '').toLowerCase().trim());
            }

            if (!input || !aviso) return;

            const valor = input.value.trim();
            if (!valor) {
                aviso.classList.add('d-none');
                return;
            }

            const existe = valoresUnicos.includes(valor.toLowerCase());
            if (!existe) {
                aviso.classList.remove('d-none');
            } else {
                aviso.classList.add('d-none');
            }
        }

        function _formatDateForInput(dateVal) {
            if (!dateVal) return '';
            const d = new Date(dateVal);
            if (isNaN(d.getTime())) return '';
            return d.toISOString().split('T')[0];
        }

        // ===== RENDER PRINCIPAL =====

        function _renderData() {
            const d = state.data;
            if (!d) return;

            // Header
            dom.headerTitle.textContent = d.comunicado || 'Sin T√≠tulo';

            // REFACTORIZADO: Ahora muestra Referencia en lugar de Cuenta
            const referenciaTexto = d.referencia || d.cuenta || d.idCuenta || 'Sin Referencia';
            dom.headerSubtitle.textContent = `ID: ${d.id} | Ref: ${referenciaTexto}`;

            // Form General
            dom.genId.value = d.id || '';

            // REFACTORIZADO: Referencia (antes Cuenta)
            if (dom.genReferencia) {
                const refValor = typeof d.referencia === 'object'
                    ? (d.referencia?.nombre || d.referencia?.referencia || '')
                    : (d.referencia || d.cuenta || d.idCuenta || '');
                dom.genReferencia.value = refValor;
            }

            // NUEVO: Ajustador
            if (dom.genAjustador) {
                const ajustadorValor = d.ajustador || 'CTA'; // Default: Charles Taylor
                if (AJUSTADORES[ajustadorValor]) {
                    dom.genAjustador.value = ajustadorValor;
                    if (dom.genAjustadorOtro) dom.genAjustadorOtro.classList.add('d-none');
                } else {
                    dom.genAjustador.value = 'Otro';
                    if (dom.genAjustadorOtro) {
                        dom.genAjustadorOtro.classList.remove('d-none');
                        dom.genAjustadorOtro.value = ajustadorValor;
                    }
                }
            }

            dom.genFecha.value = _formatDateForInput(d.fecha);
            dom.genComunicado.value = d.comunicado || '';
            dom.genDescripcion.value = d.descripcion || '';

            // Selects y Datalists
            if (d.idEstado) dom.genEstado.value = d.idEstado;

            // DISTRITO
            const distritoValor = typeof d.distrito === 'object'
                ? (d.distrito?.distritoRiego || d.distrito?.nombre || '')
                : (d.distrito || '');
            if (distritoValor) dom.genDistrito.value = distritoValor;

            // SINIESTRO
            const siniestroValor = typeof d.siniestro === 'object'
                ? (d.siniestro?.siniestro || d.siniestro?.nombre || '')
                : (d.siniestro || '');
            if (siniestroValor) {
                dom.genSiniestro.value = siniestroValor;
                _actualizarDetallesSiniestro();
            }

            // Renderizar otras pesta√±as
            _renderPresupuesto();
            _renderEquipo();
            _renderFinanciero();
            _renderTickets();
            _renderActualizaciones();
        }

        function _actualizarDetallesSiniestro() {
            if (!dom.genSiniestro) return;
            const valor = String(dom.genSiniestro.value).trim();
            _verificarNuevoRegistro('siniestro');

            const campoFenomeno = dom.genFenomeno;
            const campoFi = dom.genFi;
            const campoFondo = dom.genFondo;

            if (!valor) {
                if (campoFenomeno) { campoFenomeno.value = ''; campoFenomeno.readOnly = true; }
                if (campoFi) { campoFi.value = ''; campoFi.readOnly = true; }
                if (campoFondo) { campoFondo.value = ''; campoFondo.readOnly = true; }

                if (dom.avisoFenomeno) dom.avisoFenomeno.classList.add('d-none');
                if (dom.avisoFi) dom.avisoFi.classList.add('d-none');
                if (dom.avisoFondo) dom.avisoFondo.classList.add('d-none');
                return;
            }

            const siniestroEncontrado = (state.catalogs.siniestros || []).find(s =>
                String(s.siniestro || s.nombre || '').toLowerCase() === valor.toLowerCase()
            );

            if (siniestroEncontrado) {
                if (campoFenomeno) {
                    campoFenomeno.value = siniestroEncontrado.fenomeno || '';
                    campoFenomeno.readOnly = true;
                    campoFenomeno.classList.add('bg-light');
                }
                if (campoFi) {
                    campoFi.value = siniestroEncontrado.fi || '';
                    campoFi.readOnly = true;
                    campoFi.classList.add('bg-light');
                }
                if (campoFondo) {
                    campoFondo.value = siniestroEncontrado.fondo || '';
                    campoFondo.readOnly = true;
                    campoFondo.classList.add('bg-light');
                }

                if (dom.avisoFenomeno) dom.avisoFenomeno.classList.add('d-none');
                if (dom.avisoFi) dom.avisoFi.classList.add('d-none');
                if (dom.avisoFondo) dom.avisoFondo.classList.add('d-none');

            } else {
                if (campoFenomeno) {
                    campoFenomeno.value = '';
                    campoFenomeno.readOnly = false;
                    campoFenomeno.classList.remove('bg-light');
                    campoFenomeno.placeholder = "Ingrese Fen√≥meno...";
                    if (dom.avisoFenomeno) dom.avisoFenomeno.classList.remove('d-none');
                }
                if (campoFi) {
                    campoFi.value = '';
                    campoFi.readOnly = false;
                    campoFi.classList.remove('bg-light');
                    campoFi.placeholder = "Ingrese F.I....";
                    if (dom.avisoFi) dom.avisoFi.classList.remove('d-none');
                }
                if (campoFondo) {
                    campoFondo.value = '';
                    campoFondo.readOnly = false;
                    campoFondo.classList.remove('bg-light');
                    campoFondo.placeholder = "Ingrese Fondo...";
                    if (dom.avisoFondo) dom.avisoFondo.classList.remove('d-none');
                }
            }
        }

        // ===== PRESUPUESTO =====

        function _renderPresupuesto() {
            const tbody = dom.presupuestoBody;
            if (!tbody) {
                console.error('Body de presupuesto no encontrado');
                return;
            }
            tbody.innerHTML = '';

            const items = state.data.presupuesto || [];

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <i class="bi bi-journal-plus fs-1 d-block mb-2"></i>
                            Sin presupuesto registrado. Haga clic en Agregar para iniciar (Origen).
                        </td>
                    </tr>`;
                if (dom.totalAutorizado) dom.totalAutorizado.textContent = '$0.00';
                return;
            }

            const lastIndex = items.length - 1;

            items.forEach((item, index) => {
                if (!item) return;
                const tr = document.createElement('tr');

                const isVigente = index === lastIndex;
                const isOrigen = index === 0;
                const rowClass = isVigente ? 'table-active' : '';

                let revisionCell;
                if (isOrigen) {
                    revisionCell = `<td class="ps-4 ${rowClass}"><span class="badge bg-secondary">Origen</span></td>`;
                } else {
                    revisionCell = `
                        <td class="ps-4 ${rowClass}">
                            <input type="text" class="form-control form-control-sm text-center" 
                                value="${item.revision || ''}" 
                                placeholder="Ej: A, B, Rev-1..."
                                maxlength="10"
                                onchange="ComunicadoDetalle.updatePresupuesto(${index}, 'revision', this.value)">
                        </td>`;
                }

                tr.innerHTML = `
                    ${revisionCell}
                    <td>
                        <input type="date" class="form-control form-control-sm" 
                            value="${_formatDateForInput(item.fecha)}"
                            onchange="ComunicadoDetalle.updatePresupuesto(${index}, 'fecha', this.value)">
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control text-end currency-input" 
                                value="${_formatCurrency(item.monto, false)}" 
                                onchange="ComunicadoDetalle.updatePresupuesto(${index}, 'monto', this.value)">
                        </div>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-outline-danger btn-sm border-0" 
                            onclick="ComunicadoDetalle.removePresupuesto(${index})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Configurar inputs de moneda despu√©s de renderizar
            tbody.querySelectorAll('.currency-input').forEach(_setupCurrencyInput);

            _updateTotalPresupuesto();
        }

        function _addActualizacionPresupuesto() {
            if (!state.data.presupuesto) state.data.presupuesto = [];
            const items = state.data.presupuesto;

            const esOrigen = items.length === 0;

            state.data.presupuesto.push({
                revision: esOrigen ? 'Origen' : '',
                fecha: new Date().toISOString(),
                monto: esOrigen ? 5782812.23 : 0, // Valor ejemplo para origen
                esOrigen: esOrigen
            });
            _renderPresupuesto();
        }

        function _updateTotalPresupuesto() {
            const items = state.data.presupuesto || [];
            let totalAut = 0;

            if (items.length > 0) {
                const vigente = items[items.length - 1];
                if (vigente) {
                    totalAut = parseFloat(vigente.monto) || 0;
                }
            }

            if (dom.totalAutorizado) {
                dom.totalAutorizado.textContent = _formatCurrency(totalAut);
            }

            // Actualizar tambi√©n resumen financiero
            _updateResumenFinanciero();
        }

        // ===== EQUIPO =====

        function _renderEquipo() {
            if (!dom.listaContratistas || !dom.listaSupervisores) return;
            dom.listaContratistas.innerHTML = '';
            dom.listaSupervisores.innerHTML = '';

            const equipo = state.data.equipo || [];

            // Contratistas
            const contratistas = equipo.filter(e => e.tipo === 'contratista');
            if (contratistas.length === 0) {
                dom.listaContratistas.innerHTML = '<div class="text-center py-4 text-muted"><small>No hay contratistas asignados</small></div>';
            } else {
                contratistas.forEach((item) => {
                    const realIndex = equipo.indexOf(item);
                    const div = document.createElement('div');
                    div.className = 'list-group-item d-flex justify-content-between align-items-center';
                    div.innerHTML = `
                        <div class="flex-grow-1 me-3">
                            <input type="text" class="form-control form-control-sm border-0 fw-bold" placeholder="Nombre del Contratista" value="${item.nombre || ''}" onchange="ComunicadoDetalle.updateEquipo(${realIndex}, 'nombre', this.value)">
                            <input type="text" class="form-control form-control-sm border-0 text-muted small" placeholder="Detalles / Cargo" value="${item.detalles || ''}" onchange="ComunicadoDetalle.updateEquipo(${realIndex}, 'detalles', this.value)">
                        </div>
                        <button class="btn btn-link text-danger btn-sm" onclick="ComunicadoDetalle.removeEquipo(${realIndex})"><i class="bi bi-x-lg"></i></button>
                    `;
                    dom.listaContratistas.appendChild(div);
                });
            }

            // Supervisores
            const supervisores = equipo.filter(e => e.tipo === 'supervisor');
            if (supervisores.length === 0) {
                dom.listaSupervisores.innerHTML = '<div class="text-center py-4 text-muted"><small>No hay supervisores asignados</small></div>';
            } else {
                supervisores.forEach((item) => {
                    const realIndex = equipo.indexOf(item);
                    const div = document.createElement('div');
                    div.className = 'list-group-item d-flex justify-content-between align-items-center';
                    div.innerHTML = `
                        <div class="flex-grow-1 me-3">
                            <input type="text" class="form-control form-control-sm border-0 fw-bold" placeholder="Nombre del Supervisor" value="${item.nombre || ''}" onchange="ComunicadoDetalle.updateEquipo(${realIndex}, 'nombre', this.value)">
                            <input type="text" class="form-control form-control-sm border-0 text-muted small" placeholder="Cargo / √Årea" value="${item.detalles || ''}" onchange="ComunicadoDetalle.updateEquipo(${realIndex}, 'detalles', this.value)">
                        </div>
                        <button class="btn btn-link text-danger btn-sm" onclick="ComunicadoDetalle.removeEquipo(${realIndex})"><i class="bi bi-x-lg"></i></button>
                    `;
                    dom.listaSupervisores.appendChild(div);
                });
            }
        }

        function _addEquipo(tipo) {
            state.data.equipo.push({ tipo: tipo, nombre: '', detalles: '' });
            _renderEquipo();
        }

        // ===== FINANCIERO (REFACTORIZADO) =====

        /**
         * Renderiza la tabla de estimaciones con el nuevo modelo financiero
         * Estructura de cada estimaci√≥n:
         * - numero: N√∫mero de estimaci√≥n (1, 2, 3...)
         * - fecha: Fecha de la estimaci√≥n
         * - montoEjecutado: Estimaci√≥n Bruta (Monto Ejecutado)
         * - amortizacion: Amortizaci√≥n de Anticipo (deducci√≥n)
         * - subtotal: A pagar antes de IVA (calculado: ejecutado - amortizaci√≥n)
         * - iva: IVA (calculado: subtotal * 0.16)
         * - montoFacturado: Total Neto (calculado: subtotal + iva)
         */
        function _renderFinanciero() {
            const tbody = dom.listaEstimaciones;
            if (!tbody) return;

            tbody.innerHTML = '';

            const estimaciones = state.data.financiero?.estimaciones || [];

            if (estimaciones.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="bi bi-calculator fs-1 d-block mb-2"></i>
                            Sin estimaciones registradas. Haga clic en Nueva Estimaci√≥n para comenzar.
                        </td>
                    </tr>`;
                _updateResumenFinanciero();
                return;
            }

            estimaciones.forEach((item, index) => {
                const tr = document.createElement('tr');

                // Calcular valores autom√°ticos
                const ejecutado = parseFloat(item.montoEjecutado) || 0;
                const amortizacion = parseFloat(item.amortizacion) || 0;
                const subtotal = ejecutado - amortizacion;
                const iva = subtotal * IVA_RATE;
                const facturado = subtotal + iva;

                tr.innerHTML = `
                    <td class="ps-3">
                        <input type="text" class="form-control form-control-sm text-center fw-bold" 
                            value="${item.numero || (index + 1)}" 
                            placeholder="#"
                            style="width: 70px;"
                            onchange="ComunicadoDetalle.updateEstimacion(${index}, 'numero', this.value)">
                    </td>
                    <td>
                        <input type="date" class="form-control form-control-sm" 
                            value="${_formatDateForInput(item.fecha)}"
                            onchange="ComunicadoDetalle.updateEstimacion(${index}, 'fecha', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm text-end currency-input" 
                            value="${_formatCurrency(ejecutado, false)}"
                            onchange="ComunicadoDetalle.updateEstimacion(${index}, 'montoEjecutado', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm text-end currency-input text-danger" 
                            value="${_formatCurrency(amortizacion, false)}"
                            onchange="ComunicadoDetalle.updateEstimacion(${index}, 'amortizacion', this.value)">
                    </td>
                    <td class="text-end">
                        <span class="badge bg-light text-dark">${_formatCurrency(subtotal)}</span>
                    </td>
                    <td class="text-end">
                        <span class="text-muted small">${_formatCurrency(iva)}</span>
                    </td>
                    <td class="text-end">
                        <span class="fw-bold text-success">${_formatCurrency(facturado)}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-outline-danger btn-sm border-0" 
                            onclick="ComunicadoDetalle.removeEstimacion(${index})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Configurar inputs de moneda
            tbody.querySelectorAll('.currency-input').forEach(_setupCurrencyInput);

            _updateResumenFinanciero();
        }

        function _addEstimacion() {
            if (!state.data.financiero) state.data.financiero = {};
            if (!state.data.financiero.estimaciones) state.data.financiero.estimaciones = [];

            const count = state.data.financiero.estimaciones.length;

            // Datos de ejemplo basados en el PDF AM018479-L05
            const ejemploEstimacion = count === 0 ? {
                numero: '1',
                fecha: new Date().toISOString(),
                montoEjecutado: 3988809.81,
                amortizacion: 1994404.91
            } : {
                numero: String(count + 1),
                fecha: new Date().toISOString(),
                montoEjecutado: 0,
                amortizacion: 0
            };

            state.data.financiero.estimaciones.push(ejemploEstimacion);
            _renderFinanciero();
        }

        /**
         * MEJORA 2: Actualiza el resumen financiero con la nueva l√≥gica
         * Saldo por Ejercer = Presupuesto Autorizado - Monto Ejecutado Acumulado
         */
        function _updateResumenFinanciero() {
            // 1. Obtener presupuesto autorizado (√∫ltimo valor de presupuesto vigente)
            const presupuestoItems = state.data.presupuesto || [];
            let presupuestoAutorizado = 0;
            if (presupuestoItems.length > 0) {
                presupuestoAutorizado = parseFloat(presupuestoItems[presupuestoItems.length - 1]?.monto) || 0;
            }

            // 2. Calcular totales de estimaciones
            const estimaciones = state.data.financiero?.estimaciones || [];
            let totalEjecutado = 0;
            let totalAmortizacion = 0;
            let totalSubtotal = 0;
            let totalIva = 0;
            let totalFacturado = 0;

            estimaciones.forEach(est => {
                const ejecutado = parseFloat(est.montoEjecutado) || 0;
                const amortizacion = parseFloat(est.amortizacion) || 0;
                const subtotal = ejecutado - amortizacion;
                const iva = subtotal * IVA_RATE;
                const facturado = subtotal + iva;

                totalEjecutado += ejecutado;
                totalAmortizacion += amortizacion;
                totalSubtotal += subtotal;
                totalIva += iva;
                totalFacturado += facturado;
            });

            // 3. Calcular saldo por ejercer (seg√∫n regla de negocio)
            // Saldo por Ejercer = Presupuesto Autorizado - Monto Ejecutado Acumulado
            const saldoPorEjercer = presupuestoAutorizado - totalEjecutado;

            // 4. Calcular porcentaje de avance
            const porcentajeAvance = presupuestoAutorizado > 0
                ? Math.min((totalEjecutado / presupuestoAutorizado) * 100, 100)
                : 0;

            // 5. Actualizar totales de la tabla de estimaciones
            if (dom.totalEjecutado) dom.totalEjecutado.textContent = _formatCurrency(totalEjecutado);
            if (dom.totalAmortizacion) dom.totalAmortizacion.textContent = _formatCurrency(totalAmortizacion);
            if (dom.totalSubtotal) dom.totalSubtotal.textContent = _formatCurrency(totalSubtotal);
            if (dom.totalIva) dom.totalIva.textContent = _formatCurrency(totalIva);
            if (dom.totalFacturado) dom.totalFacturado.textContent = _formatCurrency(totalFacturado);

            // 6. Actualizar resumen financiero lateral
            if (dom.finAutorizado) dom.finAutorizado.textContent = _formatCurrency(presupuestoAutorizado);
            if (dom.finEjercido) dom.finEjercido.textContent = _formatCurrency(totalEjecutado);
            if (dom.finPorEjercer) {
                dom.finPorEjercer.textContent = _formatCurrency(saldoPorEjercer);
                // Colorear seg√∫n si hay saldo positivo o negativo
                dom.finPorEjercer.className = saldoPorEjercer >= 0
                    ? 'fw-bold fs-5 text-primary'
                    : 'fw-bold fs-5 text-danger';
            }
            if (dom.finFacturado) dom.finFacturado.textContent = _formatCurrency(totalFacturado);

            // 7. Actualizar porcentaje y barra de progreso
            if (dom.finPorcentaje) dom.finPorcentaje.textContent = `${porcentajeAvance.toFixed(1)}%`;
            if (dom.finProgressBar) {
                dom.finProgressBar.style.width = `${porcentajeAvance}%`;
                // Cambiar color seg√∫n nivel de avance
                dom.finProgressBar.className = 'progress-bar ' + (
                    porcentajeAvance < 50 ? 'bg-info' :
                        porcentajeAvance < 80 ? 'bg-primary' :
                            porcentajeAvance < 100 ? 'bg-warning' : 'bg-success'
                );
            }

            // 8. Actualizar info del ajustador
            if (dom.finAjustadorInfo && dom.genAjustador) {
                const ajustadorValue = dom.genAjustador.value;
                dom.finAjustadorInfo.textContent = AJUSTADORES[ajustadorValue] ||
                    (dom.genAjustadorOtro?.value || 'No especificado');
            }
        }

        // ===== TICKETS =====

        function _renderTickets() {
            if (!dom.listaTickets) return;
            dom.listaTickets.innerHTML = '';

            const tickets = state.data.tickets || [];
            if (tickets.length === 0) {
                dom.listaTickets.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info border-0 shadow-sm d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                            <div>
                                <strong>Sin tickets</strong>
                                <p class="mb-0 small">No hay tickets registrados para este comunicado.</p>
                            </div>
                        </div>
                    </div>`;
                return;
            }

            tickets.forEach((ticket, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-3';
                col.innerHTML = `
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-${ticket.prioridad === 'Alta' ? 'danger' : (ticket.prioridad === 'Media' ? 'warning' : 'info')}">${ticket.prioridad || 'Normal'}</span>
                                <button class="btn btn-link text-danger p-0" onclick="ComunicadoDetalle.removeTicket(${index})"><i class="bi bi-x"></i></button>
                            </div>
                            <input type="text" class="form-control form-control-sm border-0 fw-bold mb-2" placeholder="T√≠tulo del Ticket" value="${ticket.titulo || ''}" onchange="ComunicadoDetalle.updateTicket(${index}, 'titulo', this.value)">
                            <textarea class="form-control form-control-sm border-0 bg-light mb-2" rows="2" placeholder="Descripci√≥n..." onchange="ComunicadoDetalle.updateTicket(${index}, 'descripcion', this.value)">${ticket.descripcion || ''}</textarea>
                            <select class="form-select form-select-sm border-0 text-muted" onchange="ComunicadoDetalle.updateTicket(${index}, 'estado', this.value)">
                                <option value="Abierto" ${ticket.estado === 'Abierto' ? 'selected' : ''}>Abierto</option>
                                <option value="En Proceso" ${ticket.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                                <option value="Resuelto" ${ticket.estado === 'Resuelto' ? 'selected' : ''}>Resuelto</option>
                            </select>
                        </div>
                    </div>
                `;
                dom.listaTickets.appendChild(col);
            });
        }

        function _addTicket() {
            state.data.tickets.push({ titulo: '', descripcion: '', prioridad: 'Media', estado: 'Abierto' });
            _renderTickets();
        }

        function _renderActualizaciones() {
            // TODO: Implementar renderizado de historial real
        }

        // ===== GUARDAR =====

        async function _guardarTodo() {
            if (state.saving) return;
            state.saving = true;
            dom.btnGuardar.disabled = true;
            dom.btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

            try {
                // Obtener valor de ajustador
                let ajustadorFinal = dom.genAjustador?.value || 'CTA';
                if (ajustadorFinal === 'Otro' && dom.genAjustadorOtro) {
                    ajustadorFinal = dom.genAjustadorOtro.value || 'Otro';
                }

                const updates = {
                    comunicado: dom.genComunicado.value,
                    fecha: dom.genFecha.value,
                    descripcion: dom.genDescripcion.value,
                    referencia: dom.genReferencia?.value || '', // Antes: cuenta
                    ajustador: ajustadorFinal, // NUEVO
                    idEstado: dom.genEstado.value,
                    distrito: dom.genDistrito.value,
                    siniestro: dom.genSiniestro.value,
                    fenomeno: dom.genFenomeno?.value || '',
                    fi: dom.genFi?.value || '',
                    fondo: dom.genFondo?.value || '',
                    presupuesto: state.data.presupuesto || [],
                    equipo: state.data.equipo || [],
                    financiero: state.data.financiero || {},
                    tickets: state.data.tickets || []
                };

                await serverCall('updateComunicado', state.id, updates);
                alert('‚úÖ Cambios guardados correctamente.');
                await _loadData();

            } catch (error) {
                console.error('Error guardando:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            } finally {
                state.saving = false;
                dom.btnGuardar.disabled = false;
                dom.btnGuardar.innerHTML = '<i class="bi bi-save"></i> Guardar Cambios';
            }
        }

        // ===== API P√öBLICA =====

        return {
            init,
            mount,

            // Presupuesto
            updatePresupuesto: (index, field, value) => {
                if (!state.data.presupuesto[index]) return;
                if (field === 'monto') {
                    state.data.presupuesto[index][field] = _parseCurrency(value);
                } else {
                    state.data.presupuesto[index][field] = value;
                }
                _renderPresupuesto();
            },
            removePresupuesto: (index) => {
                state.data.presupuesto.splice(index, 1);
                _renderPresupuesto();
            },

            // Equipo
            updateEquipo: (index, field, value) => {
                if (!state.data.equipo[index]) return;
                state.data.equipo[index][field] = value;
                _renderEquipo();
            },
            removeEquipo: (index) => {
                state.data.equipo.splice(index, 1);
                _renderEquipo();
            },

            // Estimaciones (NUEVO modelo financiero)
            updateEstimacion: (index, field, value) => {
                const estimaciones = state.data.financiero?.estimaciones;
                if (!estimaciones || !estimaciones[index]) return;

                if (field === 'montoEjecutado' || field === 'amortizacion') {
                    estimaciones[index][field] = _parseCurrency(value);
                } else {
                    estimaciones[index][field] = value;
                }
                _renderFinanciero();
            },
            removeEstimacion: (index) => {
                const estimaciones = state.data.financiero?.estimaciones;
                if (!estimaciones) return;
                estimaciones.splice(index, 1);
                _renderFinanciero();
            },

            // Tickets
            updateTicket: (index, field, value) => {
                if (!state.data.tickets[index]) return;
                state.data.tickets[index][field] = value;
                _renderTickets();
            },
            removeTicket: (index) => {
                state.data.tickets.splice(index, 1);
                _renderTickets();
            }
        };
    })();
</script>