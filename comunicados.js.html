<script>
    /**
     * M√ìDULO IMPORTACI√ìN FRONTEND
     * Maneja la carga de archivos y la comunicaci√≥n con el backend.
     */
    globalThis.Importacion = (() => {
        'use strict';

        const dom = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            fileInfo: document.getElementById('file-info'),
            filenameDisplay: document.getElementById('filename-display'),
            btnAnalizar: document.getElementById('btn-analizar'),
            loader: document.getElementById('import-loader'),
            loaderMsg: document.getElementById('loader-msg'),
            previewContainer: document.getElementById('preview-container'),
            previewBody: document.getElementById('preview-body'),
            previewSummary: document.getElementById('preview-summary')
        };

        let currentFile = null;
        let currentCsvContent = null; // Store for confirmation step

        const init = () => {
            _cacheDom();
            _addEventListeners();
            console.log('Componente Importacion inicializado (Modal mode)');
        };

        const _addEventListeners = () => {
            // Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dom.dropZone.addEventListener(eventName, _preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dom.dropZone.addEventListener(eventName, () => dom.dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dom.dropZone.addEventListener(eventName, () => dom.dropZone.classList.remove('dragover'), false);
            });

            dom.dropZone.addEventListener('drop', _handleDrop, false);
            dom.fileInput.addEventListener('change', _handleFileSelect, false);
        };

        const _preventDefaults = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        const _handleDrop = (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            _handleFiles(files);
        };

        const _handleFileSelect = (e) => {
            const files = e.target.files;
            _handleFiles(files);
        };

        const _handleFiles = (files) => {
            if (files.length > 0) {
                currentFile = files[0];
                dom.filenameDisplay.textContent = currentFile.name;
                dom.fileInfo.classList.remove('d-none');
                dom.btnAnalizar.disabled = false;
            }
        };

        const reset = () => {
            currentFile = null;
            dom.fileInput.value = '';
            dom.fileInfo.classList.add('d-none');
            dom.btnAnalizar.disabled = true;
            dom.previewContainer.classList.add('d-none');
            dom.previewBody.innerHTML = '';

            // Preview additions
            dom.btnConfirmar.classList.add('d-none');
            dom.errorReportContainer.classList.add('d-none');
            currentCsvContent = null;
        };

        const analizar = () => {
            if (!currentFile) return;

            const fileName = currentFile.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

            if (isExcel) {
                _procesarExcel(currentFile);
            } else {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result;
                    await _procesarBackend(content);
                };
                reader.readAsText(currentFile);
            }
        };

        const _procesarExcel = async (file) => {
            _showLoader(true, 'Procesando archivo Excel...');

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    const result = await serverCall('convertirExcelACsv', base64Data);

                    if (result.success) {
                        await _procesarBackend(result.csvContent);
                    } else {
                        alert('Error al procesar Excel: ' + result.message);
                        _showLoader(false);
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error(error);
                alert('Error al leer el archivo Excel: ' + error.message);
                _showLoader(false);
            }
        };

        const _procesarBackend = async (csvContent) => {
            _showLoader(true, 'Analizando archivo y cat√°logos...');
            currentCsvContent = csvContent; // Save for later

            try {
                // PASO 1: Previsualizaci√≥n (Solo Lectura)
                // serverCall devuelve directamente 'data' si es exitoso, y lanza error si falla.
                const data = await serverCall('previsualizarImportacion', csvContent);

                if (data) {
                    _renderResultados(data);
                } else {
                    throw new Error('La respuesta de previsualizaci√≥n esta vac√≠a.');
                }

            } catch (error) {
                console.error(error);
                alert('Error en el an√°lisis: ' + error.message);
            } finally {
                _showLoader(false);
            }
        };

        const confirmar = async () => {
            if (!currentCsvContent) return;

            _showLoader(true, 'Guardando datos en la base de datos...');
            dom.btnConfirmar.disabled = true;

            try {
                // PASO 2: Ejecuci√≥n Real
                const result = await serverCall('ejecutarImportacion', currentCsvContent);

                if (result.success) {
                    if (globalThis.Swal) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Importaci√≥n Completada',
                            text: result.message + `\nTotal: ${result.resumen?.totalDocumentos} | Nuevos Siniestros: ${result.resumen?.nuevosSiniestros}`,
                            confirmButtonColor: '#0d6efd'
                        });
                    } else {
                        alert(`Importaci√≥n Completada.\n${result.message}`);
                    }

                    // Recargar tabla principal
                    if (globalThis.Comunicados && typeof Comunicados.recargar === 'function') {
                        Comunicados.recargar();
                    }

                    // Cerrar modal o reiniciar
                    reset();
                    const modalEl = document.getElementById('modalImportacion');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();

                } else {
                    alert('Error al guardar: ' + result.message);
                    dom.btnConfirmar.disabled = false;
                }
            } catch (error) {
                console.error(error);
                alert('Error cr√≠tico al guardar: ' + error.message);
                dom.btnConfirmar.disabled = false;
            } finally {
                _showLoader(false);
            }
        };

        const _renderResultados = (data) => {
            dom.previewContainer.classList.remove('d-none');
            dom.previewBody.innerHTML = '';

            const resumen = data.resumen || {};
            const filas = data.filas || [];

            dom.previewSummary.innerHTML = `
                <strong>Total Filas:</strong> ${resumen.total || 0} <span class="mx-2">|</span>
                <strong>V√°lidos:</strong> ${resumen.validos || 0} <span class="mx-2">|</span>
                <strong>Omitidos/Errores:</strong> ${resumen.omitidos || 0}
            `;

            // Mostrar bot√≥n Confirmar solo si hay v√°lidos > 0
            if (resumen.validos > 0) {
                dom.btnConfirmar.classList.remove('d-none');
                dom.btnConfirmar.disabled = false;
                dom.btnConfirmar.onclick = confirmar;
            } else {
                dom.btnConfirmar.classList.add('d-none');
            }

            // Reporte de errores (si tenemos CSV de errores, aunque en preview quizas no generamos el CSV file string aun, 
            // pero podemos mostrar el aviso visual)
            if (resumen.omitidos > 0) {
                dom.errorReportContainer.classList.remove('d-none');
                dom.errorReportMsg.textContent = `Atenci√≥n: ${resumen.omitidos} registros tienen problemas y NO se importar√°n.`;
                // En preview mode quizas no tenemos el CSV generado, ocultar bot√≥n de descarga o manejarlo diferente
                dom.btnDownloadErrors.classList.add('d-none'); // Ocultar descarga en preview
            } else {
                dom.errorReportContainer.classList.add('d-none');
            }

            const html = filas.map(d => {
                let badgeClass = 'bg-secondary';
                let badgeText = 'DESCONOCIDO';

                if (d.status === 'OMITIDO') {
                    badgeClass = 'bg-warning text-dark';
                    badgeText = '<i class="bi bi-exclamation-triangle me-1"></i>OMITIDO';
                } else {
                    badgeClass = 'bg-success';
                    badgeText = '<i class="bi bi-check-circle me-1"></i>V√ÅLIDO';
                }

                const badgeEstado = `<span class="badge ${badgeClass}">${badgeText}</span>`;

                // Analisis de entidades nuevas
                const analisisBadges = [];
                if (d.analisis) {
                    if (d.analisis.cuenta.status === 'NUEVO') analisisBadges.push('<span class="badge bg-info text-dark ms-1">Nueva Cuenta</span>');
                    if (d.analisis.siniestro.status === 'NUEVO') analisisBadges.push('<span class="badge bg-purple ms-1" style="background-color: #6f42c1;">Nuevo Siniestro</span>');
                    if (d.analisis.distrito.status === 'NUEVO') analisisBadges.push('<span class="badge bg-info text-dark ms-1">Nuevo DR</span>');
                }

                return `
                    <tr>
                        <td class="fw-bold">
                            ${d.ref || '-'}
                            ${analisisBadges.join('')}
                        </td>
                        <td>${d.comunicado || '-'}</td>
                        <td><small class="text-muted">${d.tipo || 'UNK'}</small></td> 
                        <td class="text-end font-monospace">${d.monto ? '$' + parseFloat(d.monto).toLocaleString() : '-'}</td>
                        <td class="text-end font-monospace text-muted small">${d.sumaLineas ? '$' + parseFloat(d.sumaLineas).toLocaleString() : '-'}</td>
                        <td class="text-center">${badgeEstado}</td>
                        <td class="small text-danger">${d.motivo || ''}</td>
                    </tr>
                `;
            }).join('');

            dom.previewBody.innerHTML = html;
        };

        const _descargarCsv = (base64Content, filename) => {
            const link = document.createElement('a');
            link.href = 'data:text/csv;base64,' + base64Content;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const _showLoader = (show, msg) => {
            if (show) {
                dom.loader.classList.remove('d-none');
                dom.loaderMsg.textContent = msg;
                dom.btnAnalizar.disabled = true;
                dom.dropZone.classList.add('d-none');
                dom.errorReportContainer.classList.add('d-none'); // Hide previous errors
            } else {
                dom.loader.classList.add('d-none');
                dom.btnAnalizar.disabled = false;
                dom.dropZone.classList.remove('d-none');
            }
        };

        const render = () => {
            return globalThis.TEMPLATES?.importacion || '';
        };

        const mount = (container) => {
            if (document.getElementById('modalImportacion')) {
                init();
                return;
            }
            _cacheDom();
            _addEventListeners();
        };

        const _cacheDom = () => {
            dom.dropZone = document.getElementById('drop-zone');
            dom.fileInput = document.getElementById('file-input');
            dom.fileInfo = document.getElementById('file-info');
            dom.filenameDisplay = document.getElementById('filename-display');
            dom.btnAnalizar = document.getElementById('btn-analizar');
            dom.loader = document.getElementById('import-loader');
            dom.loaderMsg = document.getElementById('loader-msg');
            dom.previewContainer = document.getElementById('preview-container');
            dom.previewBody = document.getElementById('preview-body');
            dom.previewSummary = document.getElementById('preview-summary');

            // New elements
            dom.errorReportContainer = document.getElementById('error-report-container');
            dom.errorReportMsg = document.getElementById('error-report-msg');
            dom.btnDownloadErrors = document.getElementById('btn-download-errors');
            dom.btnConfirmar = document.getElementById('btn-confirmar-importacion'); // New
        };



        const openModal = () => {
            // Ensure DOM is cached if not already
            if (!dom.previewContainer) init();

            reset();
            const modalEl = document.getElementById('modalImportacion');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } else {
                console.error('Modal de importaci√≥n no encontrado en el DOM');
            }
        };

        return {
            render,
            mount,
            init,
            reset,
            analizar,
            openModal
        };
    })();

    /**
     * Componente Comunicados
     * Muestra una tabla detallada de todos los comunicados.
     */
    globalThis.Comunicados = (() => {
        'use strict';
        console.log('üöÄ Iniciando ejecuci√≥n de componente Comunicados');

        // Estado local del componente
        let state = {
            comunicados: [],
            catalogs: { estados: [], distritosRiego: [], siniestros: [] },
            loading: false,
            error: null,
            isEditing: false
        };

        // Referencias al DOM
        let dom = {};
        let modalInstance = null;
        let comunicadoActual = null;

        /**
         * Utilidad local para escapar HTML
         */
        function escapeHtml(s) {
            return String(s ?? '').replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        /**
         * Renderiza el spinner inicial
         */
        function _renderSpinnerInicial(container) {
            container.innerHTML = `
                <section class="card shadow-sm">
                    <div class="card-body text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Cargando vista...</p>
                    </div>
                </section>
            `;
        }

        /**
         * Carga el HTML del componente desde el servidor
         */
        async function _mount(container) {
            console.log('=== PASO 2: Cargar HTML del componente Comunicados ===');
            _renderSpinnerInicial(container);

            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(html => {
                            container.innerHTML = html;
                            console.log('‚úÖ PASO 2 completado');
                            resolve(html);
                        })
                        .withFailureHandler(error => {
                            reject(error);
                        })
                        .include('comunicados');
                });
            } catch (error) {
                console.error('‚ùå PASO 2 fall√≥:', error);
                throw error;
            }
        }

        /**
         * Cachea referencias a elementos del DOM
         */
        function _cacheDomElements() {
            dom.loader = document.getElementById('comunicados-loader');
            dom.tableContainer = document.getElementById('comunicados-table-container');
            dom.tbody = document.getElementById('lista-comunicados-body');
            dom.errorAlert = document.getElementById('comunicados-error');
            dom.emptyState = document.getElementById('comunicados-empty');
            dom.totalBadge = document.getElementById('total-comunicados-badge');
            dom.btnRecargar = document.getElementById('btnRecargarComunicados');

            // Elementos del modal
            dom.modal = document.getElementById('modalDetalleComunicado');
            dom.modalLoader = document.getElementById('modal-comunicado-loader');
            dom.modalContent = document.getElementById('modal-comunicado-content');
            dom.modalError = document.getElementById('modal-comunicado-error');
            dom.btnGuardar = document.getElementById('btnGuardarComunicado');
            dom.btnEditar = document.getElementById('btnEditarComunicado');

            // Inputs del modal
            dom.inputDistrito = document.getElementById('detalle-distrito');
            dom.inputSiniestro = document.getElementById('detalle-siniestro');
            dom.avisoDistrito = document.getElementById('aviso-nuevo-distrito');
            dom.avisoSiniestro = document.getElementById('aviso-nuevo-siniestro');

            // Referencias a avisos para validaci√≥n
            dom.avisoFenomeno = document.getElementById('aviso-nuevo-fenomeno');
            dom.avisoFi = document.getElementById('aviso-nuevo-fi');
            dom.avisoFondo = document.getElementById('aviso-nuevo-fondo');

            if (dom.btnRecargar) {
                dom.btnRecargar.addEventListener('click', () => {
                    _loadComunicados();
                });
            }

            if (dom.btnGuardar) {
                dom.btnGuardar.addEventListener('click', () => {
                    _guardarCambios();
                });
            }

            if (dom.btnEditar) {
                dom.btnEditar.addEventListener('click', () => {
                    _toggleEdicion(true);
                });
            }

            // Listeners para detectar nuevos registros
            // Configurados aqu√≠ en _cacheDomElements para que se ejecuten siempre
            if (dom.inputDistrito) {
                dom.inputDistrito.addEventListener('input', () => {
                    console.log('üìù INPUT evento en distrito');
                    _verificarNuevoRegistro('distrito');
                });
            }
            if (dom.inputSiniestro) {
                dom.inputSiniestro.addEventListener('input', () => {
                    console.log('üìù INPUT evento en siniestro');
                    _verificarNuevoRegistro('siniestro');
                    _actualizarDetallesSiniestro();
                });
            }


            // Inicializar instancia del modal
            if (dom.modal && typeof bootstrap !== 'undefined') {
                modalInstance = new bootstrap.Modal(dom.modal);

                // Poblar listas desplegables cuando el modal se muestra (garantiza que DOM est√© listo)
                dom.modal.addEventListener('shown.bs.modal', () => {
                    console.log('üîî Modal mostrado, poblando combobox h√≠bridos...');
                    _poblarCombobox('distrito', state.catalogs.distritosRiego, 'distritoRiego');
                    _poblarCombobox('siniestro', state.catalogs.siniestros, 'siniestro');
                    _setupComboboxFilter('distrito', state.catalogs.distritosRiego, 'distritoRiego');
                    _setupComboboxFilter('siniestro', state.catalogs.siniestros, 'siniestro');
                });

                dom.modal.addEventListener('hidden.bs.modal', () => {
                    _toggleEdicion(false); // Resetear al cerrar
                });
            }
        }

        /**
         * Verifica si el valor ingresado es nuevo o existe en el cat√°logo
         */
        function _verificarNuevoRegistro(tipo) {
            let input, aviso, valoresUnicos;

            // Configurar seg√∫n el tipo de campo
            switch (tipo) {
                case 'distrito':
                    input = dom.inputDistrito;
                    aviso = dom.avisoDistrito;
                    valoresUnicos = (state.catalogs.distritosRiego || []).map(d =>
                        String(d.distritoRiego || d.nombre || '').toLowerCase().trim()
                    );
                    break;
                case 'siniestro':
                    input = dom.inputSiniestro;
                    aviso = dom.avisoSiniestro;
                    valoresUnicos = (state.catalogs.siniestros || []).map(s =>
                        String(s.siniestro || s.nombre || '').toLowerCase().trim()
                    );
                    break;
                case 'fenomeno':
                    input = dom.inputFenomeno;
                    aviso = dom.avisoFenomeno;
                    valoresUnicos = [...new Set((state.catalogs.siniestros || [])
                        .map(s => String(s.fenomeno || '').trim())
                        .filter(f => f)
                        .map(f => f.toLowerCase())
                    )];
                    break;
                case 'fi':
                    input = dom.inputFi;
                    aviso = dom.avisoFi;
                    valoresUnicos = [...new Set((state.catalogs.siniestros || [])
                        .map(s => String(s.fi || '').trim())
                        .filter(f => f)
                        .map(f => f.toLowerCase())
                    )];
                    break;
                case 'fondo':
                    input = dom.inputFondo;
                    aviso = dom.avisoFondo;
                    valoresUnicos = [...new Set((state.catalogs.siniestros || [])
                        .map(s => String(s.fondo || '').trim())
                        .filter(f => f)
                        .map(f => f.toLowerCase())
                    )];
                    break;
                default:
                    return;
            }

            if (!input || !aviso) {
                console.log(`‚ö†Ô∏è _verificarNuevoRegistro(${tipo}): input o aviso no encontrado`, { input, aviso });
                return;
            }

            const valor = input.value.trim();
            if (!valor) {
                aviso.classList.add('d-none');
                return;
            }

            const existe = valoresUnicos.includes(valor.toLowerCase());

            if (tipo === 'siniestro' || tipo === 'distrito') {
                console.log(`üîç Verificando ${tipo}:`, {
                    valor,
                    existe,
                    valoresUnicos: valoresUnicos.slice(0, 5),
                    totalEnCatalogo: valoresUnicos.length
                });
            }

            if (!existe) {
                aviso.classList.remove('d-none');
                console.log(`‚úÖ Mostrando aviso para ${tipo} nuevo`);
            } else {
                aviso.classList.add('d-none');
                console.log(`‚ÑπÔ∏è ${tipo} existe en cat√°logo, ocultando aviso`);
            }
        }

        /**
         * Actualiza los campos readonly de siniestro cuando se selecciona uno existente
         * Y habilita fen√≥meno/fi/fondo si es un siniestro NUEVO
         */
        function _actualizarDetallesSiniestro() {
            const valor = dom.inputSiniestro.value.trim();

            const campoFenomeno = document.getElementById('detalle-fenomeno');
            const campoFi = document.getElementById('detalle-fi');
            const campoFondo = document.getElementById('detalle-fondo');

            if (!valor) {
                // Si est√° vac√≠o, limpiar y dejar readonly
                if (campoFenomeno) {
                    campoFenomeno.value = '';
                    campoFenomeno.setAttribute('readonly', 'true');
                    campoFenomeno.classList.remove('bg-white');
                    campoFenomeno.classList.add('bg-light');
                }
                if (campoFi) {
                    campoFi.value = '';
                    campoFi.setAttribute('readonly', 'true');
                    campoFi.classList.remove('bg-white');
                    campoFi.classList.add('bg-light');
                }
                if (campoFondo) {
                    campoFondo.value = '';
                    campoFondo.setAttribute('readonly', 'true');
                    campoFondo.classList.remove('bg-white');
                    campoFondo.classList.add('bg-light');
                }
                // Ocultar advertencias
                if (dom.avisoFenomeno) dom.avisoFenomeno.classList.add('d-none');
                if (dom.avisoFi) dom.avisoFi.classList.add('d-none');
                if (dom.avisoFondo) dom.avisoFondo.classList.add('d-none');
                return;
            }

            const siniestroEncontrado = state.catalogs.siniestros.find(s =>
                String(s.siniestro || s.nombre || '').toLowerCase() === valor.toLowerCase()
            );

            if (siniestroEncontrado) {
                // SINIESTRO EXISTE ‚Üí Auto-completar y dejar readonly
                if (campoFenomeno) {
                    campoFenomeno.value = siniestroEncontrado.fenomeno || '';
                    campoFenomeno.setAttribute('readonly', 'true');
                    campoFenomeno.classList.remove('bg-white');
                    campoFenomeno.classList.add('bg-light');
                }
                if (campoFi) {
                    campoFi.value = siniestroEncontrado.fi || '';
                    campoFi.setAttribute('readonly', 'true');
                    campoFi.classList.remove('bg-white');
                    campoFi.classList.add('bg-light');
                }
                if (campoFondo) {
                    campoFondo.value = siniestroEncontrado.fondo || '';
                    campoFondo.setAttribute('readonly', 'true');
                    campoFondo.classList.remove('bg-white');
                    campoFondo.classList.add('bg-light');
                }
                // Ocultar advertencias
                if (dom.avisoFenomeno) dom.avisoFenomeno.classList.add('d-none');
                if (dom.avisoFi) dom.avisoFi.classList.add('d-none');
                if (dom.avisoFondo) dom.avisoFondo.classList.add('d-none');
            } else {
                // SINIESTRO NUEVO ‚Üí Limpiar, habilitar para edici√≥n y mostrar advertencias
                if (campoFenomeno) {
                    campoFenomeno.value = '';
                    campoFenomeno.removeAttribute('readonly');
                    campoFenomeno.classList.remove('bg-light');
                    campoFenomeno.classList.add('bg-white');
                    campoFenomeno.placeholder = 'Ingrese el tipo de fen√≥meno (ej: Granizo, Helada, Inundaci√≥n...)';
                }
                if (campoFi) {
                    campoFi.value = '';
                    campoFi.removeAttribute('readonly');
                    campoFi.classList.remove('bg-light');
                    campoFi.classList.add('bg-white');
                    campoFi.placeholder = 'Ingrese el FI correspondiente al siniestro';
                }
                if (campoFondo) {
                    campoFondo.value = '';
                    campoFondo.removeAttribute('readonly');
                    campoFondo.classList.remove('bg-light');
                    campoFondo.classList.add('bg-white');
                    campoFondo.placeholder = 'Ingrese el fondo asegurador (ej: FONDEN, CADENA...)';
                }
                // Mostrar advertencias
                if (dom.avisoFenomeno) dom.avisoFenomeno.classList.remove('d-none');
                if (dom.avisoFi) dom.avisoFi.classList.remove('d-none');
                if (dom.avisoFondo) dom.avisoFondo.classList.remove('d-none');
            }
        }

        function _toggleEdicion(habilitar) {
            state.isEditing = habilitar;
            const inputs = document.querySelectorAll('#form-detalle-comunicado input:not([readonly]), #form-detalle-comunicado select, #form-detalle-comunicado textarea');
            inputs.forEach(input => {
                // Excepciones: campos que siempre son readonly (fenomeno, fondo, fi se llenan auto)
                if (['detalle-fenomeno', 'detalle-fondo', 'detalle-fi'].includes(input.id)) return;
                input.disabled = !habilitar;
            });

            // Ya no hay botones separados de dropdown, los inputs manejan el dropdown directamente

            if (dom.btnEditar) {
                if (habilitar) dom.btnEditar.classList.add('d-none');
                else dom.btnEditar.classList.remove('d-none');
            }

            if (dom.btnGuardar) {
                if (habilitar) dom.btnGuardar.classList.remove('d-none');
                else dom.btnGuardar.classList.add('d-none');
            }
        }

        /**
         * Muestra el estado de carga
         */
        function _renderLoading() {
            if (dom.loader) dom.loader.classList.remove('d-none');
            if (dom.tableContainer) dom.tableContainer.classList.add('d-none');
            if (dom.errorAlert) dom.errorAlert.classList.add('d-none');
            if (dom.emptyState) dom.emptyState.classList.add('d-none');
        }

        /**
         * Carga los cat√°logos
         */
        async function _loadCatalogs() {
            console.log('Iniciando carga de cat√°logos...');
            try {
                const response = await serverCall('fetchComunicadoCatalogs');
                console.log('Respuesta cruda de cat√°logos:', response);

                // serverCall devuelve response.data directamente si success es true.
                // Por lo tanto, 'response' aqu√≠ ES el objeto de datos.

                if (response && response.debugLogs) {
                    console.log('--- LOGS DEL SERVIDOR (fetchComunicadoCatalogs) ---');
                    response.debugLogs.forEach(log => console.log(`SERVER: ${log}`));
                    console.log('-------------------------------------------------');
                }

                // Verificamos si tenemos los arrays esperados
                if (response && (response.estados || response.distritosRiego)) {
                    state.catalogs = response;
                    console.log('Cat√°logos asignados al estado:', state.catalogs);
                    console.log(`Estados cargados: ${state.catalogs.estados ? state.catalogs.estados.length : 0}`);

                    // Intentar poblar inmediatamente si el DOM est√° listo
                    _poblarSelectEstados();
                    _poblarDatalists();
                } else {
                    console.error('Respuesta de cat√°logos inv√°lida o sin √©xito:', response);
                }
            } catch (error) {
                console.error('Error cargando cat√°logos:', error);
            }
        }

        function _poblarSelectEstados() {
            const select = document.getElementById('detalle-estado');
            if (!select) {
                console.warn('Select de estados NO encontrado en el DOM al intentar poblar.');
                return;
            }

            if (!state.catalogs.estados || state.catalogs.estados.length === 0) {
                console.warn('No hay estados en el cat√°logo para poblar.');
                console.log('Estado del cat√°logo:', state.catalogs);
                return;
            }

            console.log(`Poblando select de estados con ${state.catalogs.estados.length} opciones.`);

            select.innerHTML = '<option value="">Seleccione un estado...</option>';
            state.catalogs.estados.forEach(est => {
                const option = document.createElement('option');
                const id = est.id !== undefined ? est.id : (est.idEstado || est.ID || est.id_estado || est.clave || est.Clave);
                const nombre = est.estado || est.nombre || est.Estado || est.entidad || est.Entidad;

                if (id !== null && id !== undefined && String(id).trim() !== '') {
                    option.value = String(id);
                    option.textContent = nombre || 'Sin nombre';
                    select.appendChild(option);
                } else {
                    console.warn('Estado sin ID v√°lido omitido:', est);
                }
            });
        }

        function _poblarDatalists() {
            // Poblar los combobox h√≠bridos
            _poblarCombobox('distrito', state.catalogs.distritosRiego, 'distritoRiego');
            _poblarCombobox('siniestro', state.catalogs.siniestros, 'siniestro');

            // Configurar el filtrado en tiempo real
            _setupComboboxFilter('distrito', state.catalogs.distritosRiego, 'distritoRiego');
            _setupComboboxFilter('siniestro', state.catalogs.siniestros, 'siniestro');
        }

        function _poblarCombobox(tipo, catalogo, campoNombre) {
            const dropdownList = document.getElementById(`dropdown-${tipo}-list`);
            if (!dropdownList || !catalogo) return;

            dropdownList.innerHTML = '';
            catalogo.forEach(item => {
                const valor = String(item[campoNombre] || item.nombre || '');
                if (!valor) return; // Saltar si est√° vac√≠o

                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-value="${escapeHtml(valor)}">${escapeHtml(valor)}</a>`;

                li.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    const input = document.getElementById(`detalle-${tipo}`);
                    input.value = valor;

                    // Trigger change para actualizar detalles de siniestro si aplica
                    if (tipo === 'siniestro') {
                        _actualizarDetallesSiniestro();
                    }
                    _verificarNuevoRegistro(tipo);
                });

                dropdownList.appendChild(li);
            });
        }

        function _setupComboboxFilter(tipo, catalogo, campoNombre) {
            const input = document.getElementById(`detalle-${tipo}`);
            const dropdownList = document.getElementById(`dropdown-${tipo}-list`);

            console.log(`üîß _setupComboboxFilter para ${tipo}:`, { input: !!input, dropdownList: !!dropdownList });

            if (!input || !dropdownList) return;

            // Evitar agregar listeners duplicados
            if (input.dataset.filterConfigured === 'true') {
                console.log(`‚ö†Ô∏è Filtro para ${tipo} ya configurado, saltando...`);
                return;
            }
            input.dataset.filterConfigured = 'true';
            console.log(`‚úÖ Configurando listener para ${tipo}`);

            input.addEventListener('input', () => {
                console.log(`üìù Input event en ${tipo}: "${input.value}"`);

                const searchTerm = input.value.toLowerCase();
                const items = dropdownList.querySelectorAll('.dropdown-item');
                let hasVisibleItems = false;

                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.parentElement.style.display = '';
                        hasVisibleItems = true;
                    } else {
                        item.parentElement.style.display = 'none';
                    }
                });

                // NOTA: Las validaciones se manejan en _cacheDomElements
            });
        }

        /**
         * Carga los comunicados desde el servidor
         */
        async function _loadComunicados() {
            state.loading = true;
            _renderLoading();

            try {
                if (state.catalogs.estados.length === 0) {
                    await _loadCatalogs();
                }

                const comunicados = await serverCall('readAllComunicados');
                state.comunicados = comunicados || [];
                _renderTable();
            } catch (error) {
                console.error('Error cargando comunicados:', error);
                state.error = error.message;
                _renderError(error.message);
            } finally {
                state.loading = false;
                if (dom.loader) dom.loader.classList.add('d-none');
            }
        }

        /**
         * Renderiza la tabla de comunicados
         */
        /**
         * Renderiza la tabla de comunicados
         */
        function _renderTable() {
            if (!state.comunicados || state.comunicados.length === 0) {
                if (dom.emptyState) dom.emptyState.classList.remove('d-none');
                if (dom.totalBadge) dom.totalBadge.textContent = '0';
                return;
            }

            if (dom.tableContainer) dom.tableContainer.classList.remove('d-none');
            if (dom.totalBadge) dom.totalBadge.textContent = state.comunicados.length;

            // Ordenar por fecha descendente (m√°s recientes primero)
            const comunicadosOrdenados = [...state.comunicados].sort((a, b) => {
                const fechaA = String(a.fecha || '');
                const fechaB = String(b.fecha || '');
                return fechaB.localeCompare(fechaA);
            });

            const html = comunicadosOrdenados.map(com => `
                <tr>
                    <!-- Referencia y Comunicado Corto eliminados. Descripci√≥n es ahora la primera columna 'Comunicado' -->
                    <td class="ps-4 fw-semibold text-primary text-truncate" style="max-width: 350px;" title="${escapeHtml(com.descripcion || '')}">
                        ${escapeHtml(com.descripcion || '')}
                    </td>
                    <td class="text-nowrap small">${escapeHtml(com.fecha || '')}</td>
                    <td class="small">${escapeHtml(com.estado || '')}</td>
                    <td class="small text-truncate" style="max-width: 200px;" title="${escapeHtml(com.contratista || '')}">${escapeHtml(com.contratista || '')}</td>
                    <td class="small font-monospace text-end text-primary fw-bold" title="Total Obra + Supervisi√≥n">${_formatCurrency(com.presupuesto)}</td>
                    <td class="small font-monospace text-end text-muted">${_formatCurrency(com.montoSupervision)}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="Comunicados.abrirModal(${com.id || ''})" title="Edici√≥n r√°pida">
                            <i class="bi bi-eye"></i> Ver
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="Comunicados.verDetalle(${com.id || ''})" title="Gesti√≥n completa">
                            <i class="bi bi-gear-fill"></i> Gesti√≥n
                        </button>
                    </td>
                </tr>
            `).join('');

            if (dom.tbody) dom.tbody.innerHTML = html;
        }

        /**
         * Abre el detalle del comunicado (Redirecci√≥n unificada)
         /**
         * Abre el detalle del comunicado en MODAL (Vista R√°pida)
         */
        function abrirModal(idComunicado) {
            if (!idComunicado) return;
            const com = state.comunicados.find(c => String(c.id) === String(idComunicado));
            if (!com) {
                console.warn('Comunicado no encontrado en memoria:', idComunicado);
                return;
            }

            comunicadoActual = com;
            _poblarFormulario(com);

            // Asegurar modo lectura al abrir
            _toggleEdicion(false);

            if (modalInstance) {
                modalInstance.show();
            } else {
                console.error('Instancia del modal no inicializada');
            }
        }

        /**
         * Formatea moneda
         */
        function _formatCurrency(val) {
            const num = parseFloat(val) || 0;
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        /**
         * Muestra un mensaje de error
         */
        function _renderError(message) {
            if (dom.errorAlert) {
                dom.errorAlert.textContent = message;
                dom.errorAlert.classList.remove('d-none');
            }
        }

        /**
         * Formatea una fecha para el input date (YYYY-MM-DD)
         */
        function _formatearFechaInput(fecha) {
            if (!fecha) return '';
            try {
                if (typeof fecha === 'string') {
                    if (fecha.includes('/')) {
                        const partes = fecha.split('/');
                        if (partes.length === 3) {
                            const dia = partes[0].padStart(2, '0');
                            const mes = partes[1].padStart(2, '0');
                            const anio = partes[2];
                            return `${anio}-${mes}-${dia}`;
                        }
                    }
                    if (fecha.includes('T')) {
                        return fecha.split('T')[0];
                    }
                    return fecha;
                }
                if (fecha instanceof Date) {
                    return fecha.toISOString().split('T')[0];
                }
            } catch (e) {
                console.error('Error formateando fecha:', fecha, e);
            }
            return '';
        }

        /**
         * Navega a la vista de detalle del comunicado (Gesti√≥n Completa)
         */
        async function verDetalle(idComunicado) {
            if (!idComunicado) return;
            // Guardar ID en sesi√≥n para que la nueva vista lo recupere
            sessionStorage.setItem('currentComunicadoId', String(idComunicado));
            // Navegar a la nueva ruta
            location.hash = '#/comunicado-detalle';
        }

        /**
         * Pobla el formulario del modal con los datos del comunicado
         */
        function _poblarFormulario(com) {
            // Campos b√°sicos
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };

            setVal('detalle-comunicado', com.comunicado);
            setVal('detalle-fecha', _formatearFechaInput(com.fecha));
            setVal('detalle-descripcion', com.descripcion);

            // Estado (Select)
            setVal('detalle-estado', com.idEstado);

            // Combobox H√≠bridos
            setVal('detalle-distrito', com.distrito);
            setVal('detalle-siniestro', com.siniestro);

            // Siniestro Detalles (Fenomeno, FI, Fondo)
            setVal('detalle-fenomeno', com.fenomeno);
            setVal('detalle-fi', com.fi);
            setVal('detalle-fondo', com.fondo);

            // Forzar actualizaci√≥n visual de readonly/bg-color para siniestro
            _actualizarDetallesSiniestro();
        }

        /**
         * Guarda los cambios del comunicado
         */
        async function _guardarCambios() {
            if (!comunicadoActual) return;

            dom.btnGuardar.disabled = true;
            dom.btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

            try {
                const updates = {
                    comunicado: document.getElementById('detalle-comunicado').value,
                    fecha: document.getElementById('detalle-fecha').value,
                    idEstado: document.getElementById('detalle-estado').value,
                    descripcion: document.getElementById('detalle-descripcion').value,
                    distrito: document.getElementById('detalle-distrito').value,
                    siniestro: document.getElementById('detalle-siniestro').value,
                    fenomeno: document.getElementById('detalle-fenomeno').value,
                    fi: document.getElementById('detalle-fi').value,
                    fondo: document.getElementById('detalle-fondo').value
                };

                console.log('üíæ Guardando comunicado con datos:', updates);

                await serverCall('updateComunicado', comunicadoActual.id, updates);

                if (modalInstance) modalInstance.hide();
                await _loadComunicados();

                // Usar SweetAlert2 si est√° disponible (globalThis.Swal)
                const swal = globalThis.Swal;
                if (swal) {
                    swal.fire({
                        icon: 'success',
                        title: 'Actualizado',
                        text: 'Comunicado actualizado correctamente',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    alert('Comunicado actualizado correctamente');
                }

            } catch (error) {
                console.error('Error guardando cambios:', error);
                dom.modalError.textContent = error.message;
                dom.modalError.classList.remove('d-none');
            } finally {
                dom.btnGuardar.disabled = false;
                dom.btnGuardar.innerHTML = '<i class="bi bi-save"></i> Guardar Cambios';
            }
        }

        /**
         * Funci√≥n de inicializaci√≥n principal
         */
        const init = async (container) => {
            try {
                await _mount(container);
                _cacheDomElements();
                await _loadComunicados(); // Esto cargar√° cat√°logos tambi√©n

                // Inicializar m√≥dulo de importaci√≥n si est√° disponible (Modal)
                if (globalThis.Importacion) {
                    Importacion.mount();
                }

                console.log('‚úÖ Componente Comunicados listo');
            } catch (error) {
                console.error('‚ùå FALLO CR√çTICO EN LA CARGA de Comunicados:', error);
                container.innerHTML = `<div class="alert alert-danger">Error fatal al cargar: ${error.message}</div>`;
            }
        };

        const mount = async (container) => init(container);

        // Exportar componente
        return {
            init,
            mount,
            abrirModal,
            verDetalle,
            recargar: _loadComunicados
        };

    })();
</script>